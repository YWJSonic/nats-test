<!DOCTYPE html>
<!-- saved from url=(0107)https://marco79423.net/articles/%E6%B7%BA%E8%AB%87-natsstan-%E5%92%8C-jetstream-%E5%85%A9%E4%B8%89%E4%BA%8B -->
<html lang="zh-hant"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@marco79423"><meta property="og:site_name" content="大類的技術手記"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="google-site-verification" content="vVs2QVhF9I_65-WfH-RD2klXRwNA5hJT1VbICZv-0ZA"><link rel="icon" href="https://marco79423.net/favicon.ico"><link rel="manifest" href="https://marco79423.net/manifest.json"><link rel="alternate" type="application/atom+xml" title="大類的技術手記" href="https://marco79423.net/api/atom.xml"><title>淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記</title><meta name="robots" content="index,follow"><meta name="description" content="事情是這個發生的……因為公司新專案需要用到 MQ，所以我們選用了 NATS Streaming (STAN) 當作我們專案的 MQ。沒想到如火如荼的密集開發一年後，某天在 Github 查看 STAN 的資料時才發現原來 ..."><meta property="og:title" content="淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記"><meta property="og:description" content="事情是這個發生的……因為公司新專案需要用到 MQ，所以我們選用了 NATS Streaming (STAN) 當作我們專案的 MQ。沒想到如火如荼的密集開發一年後，某天在 Github 查看 STAN 的資料時才發現原來 ..."><meta property="og:url" content="https://marco79423.net/articles/%E6%B7%BA%E8%AB%87-natsstan-%E5%92%8C-jetstream-%E5%85%A9%E4%B8%89%E4%BA%8B"><meta property="og:image" content="https://marco79423.net/backend/static/c0cdd7d4-4c88-11ee-9f5e-0242ac110003/"><link rel="canonical" href="https://marco79423.net/articles/%E6%B7%BA%E8%AB%87-natsstan-%E5%92%8C-jetstream-%E5%85%A9%E4%B8%89%E4%BA%8B"><meta name="next-head-count" content="17"><script type="text/javascript" async="" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/analytics.js.下載"></script><script type="text/javascript" async="" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/js(1)"></script><script data-ad-client="ca-pub-9395644566418596" async="" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/f.txt"></script><script async="" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/js(2)"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', 'UA-38552387-1', { page_path: window.location.pathname });
            </script><meta name="emotion-insertion-point" content=""><style data-emotion="mui-style-global" data-s="">html{line-height:1.15;-webkit-text-size-adjust:100%;-moz-text-size-adjust:100%;-ms-text-size-adjust:100%;text-size-adjust:100%;}body{margin:0;}main{display:block;}h1{font-size:2em;margin:0.67em 0;}hr{box-sizing:content-box;height:0;overflow:visible;}pre{font-family:monospace,monospace;font-size:1em;}a{background-color:transparent;}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;}b,strong{font-weight:bolder;}code,kbd,samp{font-family:monospace,monospace;font-size:1em;}small{font-size:80%;}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}img{border-style:none;}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button,html [type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;}fieldset{padding:0.35em 0.625em 0.75em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-decoration{-webkit-appearance:none;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details{display:block;}summary{display:-webkit-box;display:-webkit-list-item;display:-ms-list-itembox;display:list-item;}template{display:none;}[hidden]{display:none;}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;}html{font-size:16px;font-family:Arial,Microsoft JhengHei,Open Sans,sans-serif;}ul{margin:0;padding:0;list-style:none;}</style><style data-emotion="mui-style-global" data-s="">.rst-content .highlight .hll{background-color:#ffffcc;}.rst-content .highlight .c{color:#60a0b0;font-style:italic;}.rst-content .highlight .err{border:1px solid #FF0000;}.rst-content .highlight .k{color:#007020;font-weight:bold;}.rst-content .highlight .o{color:#666666;}.rst-content .highlight .cm{color:#60a0b0;font-style:italic;}.rst-content .highlight .cp{color:#007020;}.rst-content .highlight .c1{color:#60a0b0;font-style:italic;}.rst-content .highlight .cs{color:#60a0b0;background-color:#fff0f0;}.rst-content .highlight .gd{color:#A00000;}.rst-content .highlight .ge{font-style:italic;}.rst-content .highlight .gr{color:#FF0000;}.rst-content .highlight .gh{color:#000080;font-weight:bold;}.rst-content .highlight .gi{color:#00A000;}.rst-content .highlight .go{color:#808080;}.rst-content .highlight .gp{color:#c65d09;font-weight:bold;}.rst-content .highlight .gs{font-weight:bold;}.rst-content .highlight .gu{color:#800080;font-weight:bold;}.rst-content .highlight .gt{color:#0040D0;}.rst-content .highlight .kc{color:#007020;font-weight:bold;}.rst-content .highlight .kd{color:#007020;font-weight:bold;}.rst-content .highlight .kn{color:#007020;font-weight:bold;}.rst-content .highlight .kp{color:#007020;}.rst-content .highlight .kr{color:#007020;font-weight:bold;}.rst-content .highlight .kt{color:#902000;}.rst-content .highlight .m{color:#40a070;}.rst-content .highlight .s{color:#4070a0;}.rst-content .highlight .na{color:#4070a0;}.rst-content .highlight .nb{color:#007020;}.rst-content .highlight .nc{color:#0e84b5;font-weight:bold;}.rst-content .highlight .no{color:#60add5;}.rst-content .highlight .nd{color:#555555;font-weight:bold;}.rst-content .highlight .ni{color:#d55537;font-weight:bold;}.rst-content .highlight .ne{color:#007020;}.rst-content .highlight .nf{color:#06287e;}.rst-content .highlight .nl{color:#002070;font-weight:bold;}.rst-content .highlight .nn{color:#0e84b5;font-weight:bold;}.rst-content .highlight .nt{color:#062873;font-weight:bold;}.rst-content .highlight .nv{color:#bb60d5;}.rst-content .highlight .ow{color:#007020;font-weight:bold;}.rst-content .highlight .w{color:#bbbbbb;}.rst-content .highlight .mf{color:#40a070;}.rst-content .highlight .mh{color:#40a070;}.rst-content .highlight .mi{color:#40a070;}.rst-content .highlight .mo{color:#40a070;}.rst-content .highlight .sb{color:#4070a0;}.rst-content .highlight .sc{color:#4070a0;}.rst-content .highlight .sd{color:#4070a0;font-style:italic;}.rst-content .highlight .s2{color:#4070a0;}.rst-content .highlight .se{color:#4070a0;font-weight:bold;}.rst-content .highlight .sh{color:#4070a0;}.rst-content .highlight .si{color:#70a0d0;font-style:italic;}.rst-content .highlight .sx{color:#c65d09;}.rst-content .highlight .sr{color:#235388;}.rst-content .highlight .s1{color:#4070a0;}.rst-content .highlight .ss{color:#517918;}.rst-content .highlight .bp{color:#007020;}.rst-content .highlight .vc{color:#bb60d5;}.rst-content .highlight .vg{color:#bb60d5;}.rst-content .highlight .vi{color:#bb60d5;}.rst-content .highlight .il{color:#40a070;}.rst-content hr{border:solid #dddddd;border-width:1px 0 0;clear:both;margin:1.25rem 0 1.1875rem;height:0;}.rst-content a,.rst-content a:visited,.rst-content a:hover{color:#0097A7;-webkit-text-decoration:none;text-decoration:none;}.rst-content header{margin-bottom:2rem;}.rst-content header h1{font-size:2rem;margin-top:0;margin-bottom:0;}.rst-content header .meta{margin-top:15px;}.rst-content header .meta .rubric{color:#d65b4b;font-weight:bold;}.rst-content h2,.rst-content h3,.rst-content h4,.rst-content h5{color:#616161;}.rst-content h2{font-size:1.8rem;}.rst-content h3{font-size:1.5rem;}.rst-content h4{font-size:1.3rem;}.rst-content h5{font-size:1.2rem;}.rst-content ul{font-size:1.2rem;margin-left:1.2rem;}.rst-content ul li{list-style-type:circle;margin-left:1.2rem;}.rst-content ol{font-size:1.2rem;margin-left:1.2rem;}.rst-content ol li{margin-left:1.2rem;}.rst-content p{color:rgb(26,26,26);font-size:1.2rem;line-height:1.8;margin-bottom:1.25rem;}.rst-content p.rubric{font-weight:bold;font-size:larger;color:#d65b4b;}.rst-content pre{font-size:1.2rem;font-family:Consolas,Arial,Microsoft JhengHei;color:white;background:#00897B;border:1px solid #ccc;padding:0.7rem;margin-bottom:1rem;white-space:pre-wrap;}.rst-content pre.doctest-block{border:0;color:white;background:#6D6D6D;}.rst-content .highlight pre{font-size:1.2rem;font-family:Consolas,Arial;color:#505050;background-color:#ECECEC;}.rst-content table.highlighttable pre{font-size:1.2rem;font-family:Consolas,Arial;color:#505050;background-color:#ECECEC;border:none;padding:0;margin-bottom:0;}.rst-content table{border-collapse:collapse;width:100%;}.rst-content table th{background:#00897B;color:white;padding:0.7rem;font-size:1.2rem;}.rst-content table tr:nth-of-type(odd){background:#eee;}.rst-content table td{font-size:1.2rem;padding:0.7rem;border:1px solid #ccc;}.rst-content img{margin-bottom:1rem;box-shadow:2px 2px 2px rgb(0 0 0 / 70%);border:solid 1px;}@media (max-width:400px){.rst-content img{width:100%;}}.rst-content .note{background-color:#ECECEC;padding:0.1rem 0.7rem 0.7rem 0.7rem;margin-bottom:1rem;border:1px solid #ccc;}.rst-content .note p.first{font-size:1.2rem;font-weight:bold;color:#00695C;margin-bottom:0.1rem;}.rst-content .note p.last{margin-bottom:0;}.rst-content .social-block{margin-bottom:20px;}.rst-content .social-block .fb-share-button{bottom:5px;margin-right:5px;}.rst-content .series-block{background:#ECECEC;padding:20px;margin-bottom:20px;}.rst-content .series-block .title{font-weight:700;margin-bottom:30px;}.rst-content .series-block div:not(:first-of-type){margin-top:10px;}</style><style data-emotion="mui-style 1lxxl8x n40zga 1ltwbod 3f434u vfuqox x9ol69 8zrdw5 z40hk0 150svmh 106k3ex 1tw69bx gncelz 32bug0 1xele9q bsyjwa 1kcixyr 1p5vgm2 ups4zc 5dmri2 6n7j50 18jglst n1a5ie 8khlmj s1m6x7 1htbla5 17s9njd 1vo0yqy 1omjegw 1pw1gpr q4drfa n467ru 1d3byfs 15va7hz uyir9q 19k5tfa" data-s="">.mui-style-1lxxl8x{width:100%;height:100%;color:#212121;background:#616161;}.mui-style-n40zga{position:relative;width:1200px;margin:0 auto;}@media (max-width:1200px){.mui-style-n40zga{width:100%;}}.mui-style-1ltwbod{height:90px;background:#26A69A;position:relative;}.mui-style-3f434u{position:relative;margin:0;line-height:90px;padding-left:116px;}.mui-style-vfuqox{color:#0097A7;-webkit-text-decoration:none;text-decoration:none;color:#FAFAFA;font-size:2.5rem;}.mui-style-vfuqox:hover{color:#006064;}.mui-style-vfuqox:hover{color:#FAFAFA;}@media (max-width:500px){.mui-style-vfuqox{font-size:2rem;}}.mui-style-x9ol69{position:absolute;top:18px;left:28px;width:54px;height:54px;-webkit-transform:rotate(-10deg);-moz-transform:rotate(-10deg);-ms-transform:rotate(-10deg);transform:rotate(-10deg);transition-duration:0.8s;-webkit-backface-visibility:hidden;}.mui-style-x9ol69:hover{-webkit-transform:rotate(10deg);-moz-transform:rotate(10deg);-ms-transform:rotate(10deg);transform:rotate(10deg);}.mui-style-8zrdw5{height:42px;background:#00897B;}@media (max-width:1200px){.mui-style-z40hk0{position:absolute;}.mui-style-z40hk0:hover{width:160px;}.mui-style-z40hk0:hover ul{display:block;}}.mui-style-150svmh{color:#0097A7;-webkit-text-decoration:none;text-decoration:none;display:block;height:42px;line-height:42px;padding:0 16px;font-size:1.2rem;color:#ECECEC;background:#00897B;font-weight:700;display:none;}.mui-style-150svmh:hover{color:#006064;}.mui-style-150svmh:hover{color:#ECECEC;background:#006064;}@media (max-width:1200px){.mui-style-150svmh{background:#00897B;}}@media (max-width:1200px){.mui-style-150svmh{display:block;background:#00897B;}.mui-style-150svmh:hover{background:none;}}.mui-style-106k3ex{float:left;}.mui-style-106k3ex li{float:left;}@media (max-width:1200px){.mui-style-106k3ex{display:none;}.mui-style-106k3ex li{float:none;width:100%;}}@media (max-width:1200px){.mui-style-106k3ex{float:none;}}.mui-style-1tw69bx{color:#0097A7;-webkit-text-decoration:none;text-decoration:none;display:block;height:42px;line-height:42px;padding:0 16px;font-size:1.2rem;color:#ECECEC;background:#00897B;font-weight:700;}.mui-style-1tw69bx:hover{color:#006064;}.mui-style-1tw69bx:hover{color:#ECECEC;background:#006064;}@media (max-width:1200px){.mui-style-1tw69bx{background:#00897B;}}.mui-style-gncelz{float:right;}.mui-style-gncelz li{float:left;}@media (max-width:1200px){.mui-style-gncelz{display:none;}.mui-style-gncelz li{float:none;width:100%;}}@media (max-width:1200px){.mui-style-gncelz{float:none;border-top:3px #00695C solid;}}.mui-style-32bug0{background:#EEEEEE;overflow:auto;}.mui-style-1xele9q{float:left;width:800px;}@media (max-width:1200px){.mui-style-1xele9q{width:100%;}}.mui-style-bsyjwa{background:white;padding:32px;}.mui-style-1kcixyr h2{margin:3px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}.mui-style-1p5vgm2{color:#0097A7;-webkit-text-decoration:none;text-decoration:none;font-size:2rem;}.mui-style-1p5vgm2:hover{color:#006064;}.mui-style-ups4zc{font-size:0.9rem;line-height:1.6rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}.mui-style-5dmri2{display:inline;}.mui-style-5dmri2:not(:first-of-type){margin-left:8px;}.mui-style-6n7j50{display:inline;}.mui-style-18jglst{margin:0;display:inline;}.mui-style-18jglst:not(:first-of-type):before{content:"/";margin:0 3px;}.mui-style-n1a5ie{color:#0097A7;-webkit-text-decoration:none;text-decoration:none;}.mui-style-n1a5ie:hover{color:#006064;}.mui-style-8khlmj{margin-bottom:-5px;}.mui-style-8khlmj:hover{-webkit-transform:rotate(-10deg);-moz-transform:rotate(-10deg);-ms-transform:rotate(-10deg);transform:rotate(-10deg);}.mui-style-s1m6x7{display:none;position:absolute;line-height:1.2em;padding:4px;border-radius:3px;background:#00897B;color:#FFFFFF;-webkit-transition:opacity .3s ease-out;transition:opacity .3s ease-out;}.mui-style-s1m6x7:before{content:"";position:absolute;width:0;height:0;left:-15px;top:4px;border:8px solid transparent;border-right-color:#00897B;}@media (max-width:800px){.mui-style-s1m6x7{display:none;}}.mui-style-1htbla5{margin-top:16px;font-size:1.2rem;line-height:1.6rem;}.mui-style-17s9njd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:1rem;}.mui-style-17s9njd >div:not(:first-of-type){margin-left:.5rem;}.mui-style-1vo0yqy{float:left;background:#EEEEEE;}@media (max-width:1200px){.mui-style-1vo0yqy{width:100%;background:#757575;}}.mui-style-1omjegw{margin:30px;width:340px;position:relative;}.mui-style-1omjegw h2{color:#616161;font-size:1.5em;font-weight:700;border-bottom:1px solid #EEEEEE;padding-bottom:10px;}.mui-style-1pw1gpr{padding-top:8px;font-size:1rem;}.mui-style-1pw1gpr h3{margin:0;color:#616161;font-weight:700;font-size:1.2rem;}@media (max-width:1200px){.mui-style-1pw1gpr h3{color:#ECECEC;}}.mui-style-q4drfa{margin-top:8px;color:#6F6F6F;display:inline-block;}@media (max-width:1200px){.mui-style-q4drfa{color:#ECECEC;}}.mui-style-n467ru{margin-top:8px;overflow:auto;}.mui-style-n467ru li{float:left;}.mui-style-n467ru li:not(:first-of-type){margin-left:4px;}.mui-style-1d3byfs{display:block;width:24px;height:24px;text-indent:110%;overflow:hidden;background:url(/img/icon/i-github.svg) no-repeat;-webkit-background-size:100%;background-size:100%;}.mui-style-15va7hz{display:block;width:24px;height:24px;text-indent:110%;overflow:hidden;background:url(/img/icon/i-twitter.svg) no-repeat;-webkit-background-size:100%;background-size:100%;}.mui-style-uyir9q{margin:30px;width:340px;}.mui-style-uyir9q h2{color:#616161;font-size:1.5em;font-weight:700;border-bottom:1px solid #EEEEEE;padding-bottom:10px;}@media (max-width:1200px){.mui-style-uyir9q{display:none;}}.mui-style-uyir9q li:not(:first-of-type){margin-top:8px;}.mui-style-19k5tfa{margin:0 auto;text-align:center;line-height:42px;color:#ECECEC;}</style><style data-emotion="mui-style" data-s=""></style><noscript data-n-css=""></noscript><script defer="" nomodule="" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/polyfills-c67a75d1b6f99dc8.js.下載"></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/webpack-36d12a75f0098f30.js.下載" defer=""></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/framework-114634acb84f8baa.js.下載" defer=""></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/main-83bb7170d9487b60.js.下載" defer=""></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/_app-fd66b12783771b05.js.下載" defer=""></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/168-e5310a2bb115eec9.js.下載" defer=""></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/148-58b8b62597ee24da.js.下載" defer=""></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/309-1daeba047b5ab4cb.js.下載" defer=""></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/659-41e715094dc43bfa.js.下載" defer=""></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/[slug]-1104cae5d417dd26.js.下載" defer=""></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/_buildManifest.js.下載" defer=""></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/_ssgManifest.js.下載" defer=""></script><script async="" type="text/javascript" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/embed.js.下載"></script><link as="script" rel="prefetch" href="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/720-b26d70a16eb47be9.js.下載"><link as="script" rel="prefetch" href="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/index-4705ffea7e0fa940.js.下載"><link as="script" rel="prefetch" href="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/[category]-9bc9a12a8ffc5d66.js.下載"><link as="script" rel="prefetch" href="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/archives-3b5d19f55af6cd87.js.下載"><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/alfie_v4.63f1ab6d6b9d5807dc0c94ef3fe0b851.js.下載" async="" charset="UTF-8"></script></head><body><div id="__next"><div class="mui-style-1lxxl8x"><div class="mui-style-n40zga"><header class="mui-style-1ltwbod e1qn4d130"><h1 class="mui-style-3f434u e1qn4d131"><a class="e1qn4d133 mui-style-vfuqox" href="https://marco79423.net/"><img src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/logo@58x58.jpg" class="mui-style-x9ol69 e1qn4d132">大類的技術手記</a></h1></header><nav class="mui-style-8zrdw5 e1nf7oh0"><div class="mui-style-z40hk0 e1nf7oh2"><a class="e1nf7oh3 mui-style-150svmh" href="https://marco79423.net/articles/%E6%B7%BA%E8%AB%87-natsstan-%E5%92%8C-jetstream-%E5%85%A9%E4%B8%89%E4%BA%8B#">選單</a><ul class="mui-style-106k3ex e1nf7oh5"><li><a class="e1nf7oh1 mui-style-1tw69bx" href="https://marco79423.net/articles/category/%E6%8A%80%E8%A1%93%E5%88%86%E4%BA%AB">技術分享</a></li><li><a class="e1nf7oh1 mui-style-1tw69bx" href="https://marco79423.net/articles/category/%E5%B0%88%E6%A1%88%E4%BD%9C%E5%93%81">專案作品</a></li><li><a class="e1nf7oh1 mui-style-1tw69bx" href="https://marco79423.net/articles/category/%E9%9A%A8%E6%89%8B%E8%A8%98">隨手記</a></li></ul><ul class="mui-style-gncelz e1nf7oh6"></ul></div></nav><main class="mui-style-32bug0 e460ttg0"><section class="mui-style-1xele9q e1oh205q0"><article class="mui-style-bsyjwa"><header class="mui-style-1kcixyr"><h2><a class="mui-style-1p5vgm2" href="https://marco79423.net/articles/%E6%B7%BA%E8%AB%87-natsstan-%E5%92%8C-jetstream-%E5%85%A9%E4%B8%89%E4%BA%8B">淺談 NATS、STAN 和 JetStream 兩三事</a></h2><ul class="mui-style-ups4zc erufswf0"><li class="mui-style-5dmri2 erufswf1">分類：<ul class="mui-style-6n7j50 erufswf2"><li class="mui-style-18jglst erufswf3"><a class="mui-style-n1a5ie" href="https://marco79423.net/articles/category/%E6%8A%80%E8%A1%93%E5%88%86%E4%BA%AB">技術分享</a></li></ul></li><li class="mui-style-5dmri2 erufswf1">字數：<img src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/chicken.png" alt="雞" class="mui-style-8khlmj erufswf4"> x <!-- -->6<span class="mui-style-s1m6x7 erufswf5">雞數：計算文長的常見計量單位，一般而言數字大小與文章長度呈正相關</span></li></ul></header><div><div class="rst-content mui-style-1htbla5 ewqmds0"><p>事情是這個發生的……</p>
<p>因為公司新專案需要用到 MQ，所以我們選用了 NATS Streaming (STAN) 當作我們專案的 MQ。</p>
<p>沒想到如火如荼的密集開發一年後，某天在 Github 查看 STAN 的資料時才發現原來 STAN 要被開發團隊棄用了……</p>
<img alt="1.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/1.png" style="width: 100%;">
<p>（來源: <a class="reference external" href="https://github.com/nats-io/nats-streaming-server">https://github.com/nats-io/nats-streaming-server</a>）</p>
<p>……三小？</p>
<p>看上面說明，開發團隊建議改用他們的新產品 JetStream，取代現有的 STAN。</p>
<p>所以 JetStream 是啥？聽都沒聽過？</p>
<p>於是決定來研究一下 JetStream 究竟是何方神聖？並藉此機會順便回顧一下先前的 Core NATS 和 NATS Streaming 兩套產品，並且比較一下新舊產品的差異。</p>
<p>這次分享的主題主要有三個部分：</p>
<ul class="simple">
<li>一是簡單介紹 Message Queue (MQ) 的概念和其用途；</li>
<li>二是分別介紹 NATS、NATS Streaming 和這次的重點 JetStream；</li>
<li>最後再做個簡易的評測。</li>
</ul>
<div class="section" id="message-queue-mq">
<h2>Message Queue (MQ)</h2>
<p>Message Queue (MQ)，時常翻譯為「訊息佇列」或「消息隊列」，常見的開源選擇有 RabbitMQ、Kafka 和今天要談的 NATS。</p>
<img alt="2.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/2.png" style="width: 100%;">
<p>Message Queue 本身可以簡單想像成是一個服務級別的 Queue，同樣訊息先進先出，差別在因為這是獨立的服務，所以通常必須異步處理；另一個分別是通常 Queue 是一進一出，一則訊息被一個消費者接收，另一個就收不到，但 Message Queue 可以做到讓每個消費者都能收到全部的訊息(這通常是可選的)。</p>
<p>MQ 概念上大致可以分別兩個角色，分別是：</p>
<ul class="simple">
<li>生產者 (Producer)</li>
<li>消費者 (Consumer)</li>
</ul>
<p>生產者負責生產訊息 (Message)，並丟進 MQ，而消費者負責接收並處理訊息。兩者可以完全不用知道對方，只要和 MQ 溝通即可。</p>
<p>換句話說，只要生產者產生的訊息符合消費者能接收的格式，那麼其實不一定具體非得由哪個生產者才能生產。因為無論是單個生產者還是多個不同的生產者，對身為接收端的消費者都無所謂，只要能正常收到符合條件格式的訊息即可。</p>
<p>反過來也是如此，生產者只管生產，至於後端究竟有多少個消費者消費，對生產者來說無關緊要，也不會影響程式碼，可以讓生產者和消費者各自都擁有最大的彈性。</p>
<p>套用我流解釋，使用 MQ 可以有幾個好處：</p>
<ul class="simple">
<li>更簡單</li>
<li>更可靠</li>
<li>更大更強</li>
</ul>
<div class="section" id="section-1">
<h3>更簡單 - 程式簡化和解耦</h3>
<img alt="3.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/3.png" style="width: 100%;">
<p>使用 MQ 可以方便讓不同服務解耦，正如前面所說，所有服務不管是生產者還是消費者 ，全部都統一都只和 MQ 溝通，生產者不用管是誰處理或是什麼時候處理，而消費者也不用管是誰生產的內容。</p>
<p>因此無論是生產者還是消費者都可以自由的拆分成多個服務，讓每個服務都只負責一件事，程式碼可以很單純。</p>
<p>也就是說只要能和 MQ 溝通，不管是用什麼程式語言、用什麼方式處理皆無所謂，就算後面其實是一隻雞在處理也可以。</p>
<pre class="literal-block">你永遠不會知道網路上和你聊天的是不是一隻雞，但如果他真的能用你理解的方式溝通、協作，那對方是不是只是一隻雞其實也沒差了。
</pre>
<p>更進一步說，其實連時間也解耦了，因為中間隔了一層 MQ，所以不一定需要生產者和消費者同時在線上。</p>
<p>生產者在生產訊息時，沒人規定消費者非得即時在線上處理；反之亦然，消費者在處理訊息時，生產者也不一定要同時在線上生產訊息。</p>
</div>
<div class="section" id="section-2">
<h3>更可靠 - 服務掛掉也沒差的能力</h3>
<img alt="4.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/4.png" style="width: 100%;">
<p>在這個架構下，因為生產者或消費者不需要直接連結，所以即使服務掛掉，系統還能一定程度的繼續運作。</p>
<p>因為 MQ 通常都有一定程度的儲存訊息的能力，所以即使某一個消費者掛掉，也可以等到它復活後再繼續把之前沒推送成功的訊息再推送給它。</p>
<p>雖然處理時間多少會受影響，但至少訊息不會掉，在多數情境下，這樣也不會影響到系統的運作。</p>
</div>
<div class="section" id="section-3">
<h3>更大更強 - 大流量的緩衝</h3>
<img alt="5.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/5.png" style="width: 100%;">
<p>網路服務的流量並不一定是恆定的，系統有時可能會突然面臨超大量的網路請求，但是即使要開更多台服務器也需要一點時間，這時 MQ 就可以當作「漏斗」一樣的功能，充當緩充。</p>
<p>等到足夠數量的服務啟動完畢，可以跟上訊息生產的速度了，就可以處理之前來不及處理的訊息了。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">另一種假設是這類超大量的網路請求不會一直持續，所以如果業務許可，也可以選擇不啟動新的服務器，讓 MQ 先接收下來就好，之後再讓消費者慢慢消化，用時間換取資源，也是一種選擇。</p>
</div>
</div>
</div>
<div class="section" id="core-nats">
<h2>Core NATS</h2>
<img alt="6.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/6.png" style="width: 100%;">
<p>這裡首先介紹 Core NATS，此處有個很容易混淆的點是 NATS 其實有三項產品：一是 Core NATS、另一是 NATS Streaming，最後還有最新的 JetStream。</p>
<p>因為官網的文件是直接把這三者的內容寫在一起，所以一開始沒看清楚很容易會以為是同樣的東西。但其實這是各自擁有不同概念的三項產品。</p>
<p>Core NATS（以下簡稱 NATS），一個開源、雲原生、用 Golang 寫的訊息傳遞系統，也是 NATS 最基礎的產品。</p>
<p>NATS 使用「發布」和「訂閱」的方式和程式溝通，並且不做任何持久性的處理，非常單純，所以效能也相當好。</p>
<p>程式操作也非常簡單，這裡介紹一下簡單的例子。</p>
<div class="section" id="nats">
<h3>範例 - NATS 連線</h3>
<div class="highlight"><pre><span></span><span class="c1">// 連線</span><span class="w"></span>
<span class="nx">natsConn</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">nats</span><span class="p">.</span><span class="nx">Connect</span><span class="p">(</span><span class="s">"nats://localhost:4222"</span><span class="p">)</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"連不上 NATS"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">defer</span><span class="w"> </span><span class="nx">natsConn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="nats-1">
<h3>範例 - NATS 發送訊息</h3>
<div class="highlight"><pre><span></span><span class="c1">// 發送訊息</span><span class="w"></span>
<span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">natsConn</span><span class="p">.</span><span class="nx">Publish</span><span class="p">(</span><span class="s">"subject"</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">"Hello world"</span><span class="p">))</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"送不出去"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// 清空緩衝</span><span class="w"></span>
<span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">natsConn</span><span class="p">.</span><span class="nx">Flush</span><span class="p">()</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"清空失敗"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>基於效能因素，函式庫會先緩充要發送的訊息，直到一定量的時候才會發送。但如果應用程式有需求要確保想處理的已經確實處理好了，可以使用 flush 函式立即處理。</p>
<p class="last">(來源：<a class="reference external" href="https://docs.nats.io/developing-with-nats/sending/caches">https://docs.nats.io/developing-with-nats/sending/caches</a>)</p>
</div>
</div>
<div class="section" id="nats-2">
<h3>範例 - NATS 接收訊息</h3>
<div class="highlight"><pre><span></span><span class="c1">// 接收訊息</span><span class="w"></span>
<span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">natsConn</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="s">"subject"</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">*</span><span class="nx">nats</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"收到了"</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">Data</span><span class="p">))</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"訂閱失敗"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="queue-groups">
<h3>Queue Groups</h3>
<p>NATS 內建 Load balancing 的功能，你可以在訂閱的時候隨便指定一個 Queue 的名稱，NATS 會確保訊息能自動分配訊息到同一個 Queue Group 的不同的消費者。</p>
<img alt="7.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/7.png" style="width: 100%;">
<div class="highlight"><pre><span></span><span class="c1">// 訂閱時直接指定 Queue 的名稱，不需要用設定檔預先設定</span><span class="w"></span>
<span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">natsConn</span><span class="p">.</span><span class="nx">QueueSubscribe</span><span class="p">(</span><span class="s">"subject"</span><span class="p">,</span><span class="w"> </span><span class="s">"queue"</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">*</span><span class="nx">nats</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"收到了"</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">Data</span><span class="p">))</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"訂閱失敗"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>這樣一來，即使一個 Subject 有多個消費者一起處理，每則訊息也只會被處理一次，非常方便。</p>
</div>
<div class="section" id="section-4">
<h3>「最多一次」交付模型</h3>
<p>前面說到，NATS 本身不做任何持久性處理，換句話說，如果 NATS 發送訊息的時候如果沒人接，掉了就掉了， NATS 也不會理它，訊息便有可能會丟失。</p>
<img alt="8.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/8.png" style="width: 100%;">
<p>雖然 NATS 本身不管這件事，但它提供了一種稱為 Request / Reply 的解決方案。</p>
<p>簡單來說就兩件事：</p>
<ul class="simple">
<li>消費者主動回傳「收到」的訊息給生產者知道有收到</li>
<li>讓開發者自行解決有沒有收到的問題</li>
</ul>
<img alt="9.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/9.png" style="width: 100%;">
</div>
<div class="section" id="request-reply">
<h3>範例 - Request / Reply 機制</h3>
<div class="highlight"><pre><span></span><span class="c1">// 自動建立一個唯一 subject</span><span class="w"></span>
<span class="nx">reply</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">nats</span><span class="p">.</span><span class="nx">NewInbox</span><span class="p">()</span><span class="w"></span>

<span class="c1">// 發送訊息</span><span class="w"></span>
<span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">natsConn</span><span class="p">.</span><span class="nx">PublishRequest</span><span class="p">(</span><span class="s">"subject"</span><span class="p">,</span><span class="w"> </span><span class="nx">reply</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">"Hello world"</span><span class="p">))</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"送不出去"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>此例的 reply 其實就是一個普通的 Subject，可以正常透過 Subscribe 監聽，用來接收消費者回傳的「收到」訊息。</p>
<div class="highlight"><pre><span></span><span class="c1">// 接收訊息</span><span class="w"></span>
<span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">natsConn</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="s">"subject"</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">*</span><span class="nx">nats</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"收到了"</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">Data</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="nx">msg</span><span class="p">.</span><span class="nx">Respond</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">"我收到了"</span><span class="p">))</span><span class="w"> </span><span class="c1">// 生產者會監聽 reply，來確認消費者有沒有收到</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"訂閱失敗"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Respond 意思就是回傳訊息給上例的 reply，只要生產者有監聽，就可以收到該訊息。藉此讓生產者自行處理「收到」或是「沒收到」的情況。</p>
<p>當然，這是有需要判斷有沒有收到的場景才需要這麼做，如果本身是不介意掉訊息的場景那就沒差了。</p>
</div>
<div class="section" id="nats-3">
<h3>NATS 小結</h3>
<p>簡單來說，Core NATS 的好處就是速度很快，簡單易用，而且對我來說因為是用 Golang 寫的，有什麼問題比較容易自己找到原因。</p>
<p>但因為有可能因為以消費者掛掉而掉訊息，所以適合需要大量、低延遲的場景 (比 Kafka 低很多)，而且不擔心漏訊息的場景 (或是能自行維護也行)。</p>
</div>
</div>
<div class="section" id="nats-streaming-stan">
<h2>NATS Streaming (STAN)</h2>
<p>NATS Streaming，縮寫為 STAN，與前述的 Core NATS 相比，最重要的就是新增了持久化的功能，可以說就是「有持久化功能的 NATS」。</p>
<p>具體的應用場景，大約有下列四種情況：</p>
<ul class="simple">
<li>需要訊息的歷史紀錄 (需要 Replay data 的時候)</li>
<li>Producer 和 Consumer 高度解偶，有可能不是同時在線</li>
<li>Producer 和 Consumer 需要按照自己的節奏發送、或是接收資料</li>
<li>最後一條訊息對 Consumer 是必須的 (Producer 可能離線)</li>
</ul>
<p>根據官方的說法，其實大部分用原始的 NATS 即可，如果要確保收到，可以透過前述的 Request / Reply 機制解決，官方相信自行在應用端管理，長久下來會比直接用 STAN 更加穩定。</p>
<p>(當然啦，身為苦逼的開發者，不一定都有機會可以能長遠的看待問題就是了……)</p>
<div class="section" id="stan">
<h3>獨立的 STAN</h3>
<p>雖然乍聽起來， STAN 好像只是 NATS 多了持久化的功能而已，但其實兩者幾乎是完全不同的東西， STAN 有完全屬於自己的概念，有自己獨立的函式庫，只是函式庫內部使用 NATS 連線而已。</p>
<img alt="10.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/10.png" style="width: 100%;">
<p>由於 STAN 只是將 NATS 當作連線工具使用，會用自己的方式將資訊做包裝，如果你直接透過 NATS 來觀察，你發現完全看不出什麼鬼。</p>
<p>簡單來說， STAN 與 NATS 是不同的東西。</p>
<p>好比說客戶端在連上 STAN 需要指定使用的 Cluster ID，也要自行指定自己的 Client ID。</p>
<p>而這邊的 Client ID 是專屬於 NATS Streaming 的概念，並不是 NATS 的 Client ID (但因為是用 NATS 連線，所以同時仍然也會有 NATS 的 Client ID)。</p>
</div>
<div class="section" id="stan-1">
<h3>範例 - STAN 連線</h3>
<div class="highlight"><pre><span></span><span class="c1">// 連線</span><span class="w"></span>
<span class="nx">stanConn</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stan</span><span class="p">.</span><span class="nx">Connect</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">"test-cluster"</span><span class="p">,</span><span class="w"> </span><span class="c1">// Cluster ID</span><span class="w"></span>
<span class="w">    </span><span class="s">"clientID"</span><span class="p">,</span><span class="w">   </span><span class="c1">// 客戶端自設的 Client ID</span><span class="w"></span>
<span class="w">    </span><span class="nx">stan</span><span class="p">.</span><span class="nx">NatsURL</span><span class="p">(</span><span class="s">"nats://localhost:4222"</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nx">stan</span><span class="p">.</span><span class="nx">NatsOptions</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="nx">nats</span><span class="p">.</span><span class="nx">Name</span><span class="p">(</span><span class="s">"NATS 連線名稱"</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">),</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"連不上 STAN"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">defer</span><span class="w"> </span><span class="nx">stanConn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span><span class="w"></span>
</pre></div>
<p>此外， STAN 使用的是 Channel 而非 Subject，雖然看似相同，但實際卻有差別。</p>
<p>NATS 原生的 Subject 可以支援 wildcard，我們可以在直接訂閱 <cite>chicken.*</cite> ，那麼無論是 <cite>chicken.a</cite> 又或是 <cite>chicken.b</cite> 也都能收到訊息，但 NATS Streaming 的 Channel 就不支援這麼做。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>不知為何，雖然官網說 STAN 用的是 Channel 而非 Subject，但函式庫的命名還是使用 subject</p>
<p class="last">(來源： <a class="reference external" href="https://docs.nats.io/developing-with-nats-streaming/streaming">https://docs.nats.io/developing-with-nats-streaming/streaming</a>)</p>
</div>
<p>而 STAN 使用的訊息也是不同的物件，一個是 <tt class="docutils literal">nats.Msg</tt> 另一個是 <tt class="docutils literal">stan.Msg</tt> 。</p>
</div>
<div class="section" id="stan-2">
<h3>範例 - STAN 發送訊息</h3>
<div class="highlight"><pre><span></span><span class="c1">// 發送訊息</span><span class="w"></span>
<span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stanConn</span><span class="p">.</span><span class="nx">Publish</span><span class="p">(</span><span class="s">"channel"</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">"Hello world"</span><span class="p">))</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"送不出去"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="stan-3">
<h3>範例 - STAN 接收訊息</h3>
<div class="highlight"><pre><span></span><span class="c1">// 接收訊息</span><span class="w"></span>
<span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stanConn</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="s">"channel"</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">*</span><span class="nx">stan</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 使用 stan.Msg</span><span class="w"></span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"收到了"</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">Data</span><span class="p">))</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"訂閱失敗"</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="durable">
<h3>Durable</h3>
<p>因為 STAN 多了持久化的功能，所以消費者端這邊就不用在生產者生產訊息的時候即時接收，只要訊息還存在 STAN 裡，就可以自行選擇任意時間和位置開始接收訊息。</p>
<p>但是如果消費者端每次都要隨時自己記得自己收到哪裡也很麻煩，所以 STAN 也多了 Durable 的概念。</p>
<p>STAN 本身會幫忙記錄消費者收到哪裡，如果消費者斷線回復，STAN 會自動從斷線的地方開始送。</p>
<p>消費者可以在訂閱的時候指定 Durable 名稱，STAN 會把消費者的 Client ID 和 Durable 當作 Key 記錄當前接收到的位置。假若消費者因故斷線重連，那麼 STAN 就會根據 Client ID 和 Durable 判斷從哪個位置開始發送。</p>
<p>由於 STAN 也支援前述的  Queue Groups 的功能，所以 STAN 的訂閱其實有四種組合，分別為：</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">類型</th>
<th class="head">說明</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Regular</td>
<td>最基本的訂閱模式，當應用關掉、取消訂閱時，就會失去位置，下次訂閱需要重新指定</td>
</tr>
<tr><td>Durable</td>
<td>消費者斷線時會保留位置，下次訂閱還會從上次最後接收的位置開始 (不包含主動取消訂閱)</td>
</tr>
<tr><td>Queue</td>
<td>多個消費者共享位置，但全部斷線就會失去位置</td>
</tr>
<tr><td>Durable / Queue</td>
<td>多個消費者共享位置，但即使全部斷線也不會失去位置 (除非最後一個主動取消訂閱)</td>
</tr>
</tbody>
</table>
<p>簡單來說， Durable 就是保留位置，而 Queue 就是共用位置，兩兩相乘就是四種可能。</p>
<p>至於 Durable 和 Durable / Queue 的差別在於前者以 ClientID 和 Durable 為 Key 記錄最後收到的訊息位置，而後者則是以 Queue 和 Durable 為 Key 來記錄。所以對於前者來說，如果不同 ClientID ，就會各自當不同的訂閱，而後者則會共用同一個。</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<tbody valign="top">
<tr><td>Durable</td>
<td>Server 會維護一份訂閱紀錄 (ClientID + Durable 為 Key) 記錄最後收到的訊息位置</td>
</tr>
<tr><td>Durable / Queue</td>
<td>Server 同樣會維護一訂閱紀錄 (Queue + Durable 為 Key) 記錄最後收到的訊息位置 (這種情況下 ClientID 不重要)</td>
</tr>
</tbody>
</table>
<p>(來源：<a class="reference external" href="https://github.com/nats-io/nats-streaming-server/issues/723#issuecomment-452361690">https://github.com/nats-io/nats-streaming-server/issues/723#issuecomment-452361690</a>)</p>
</div>
<div class="section" id="section-5">
<h3>「至少一次」交付模型</h3>
<p>如果說 NATS 提供的是「最多一次」的交付模型，那麼 STAN 就是「至少一次」的交付模型，因為多了持久化的功能，所以 STAN 可以保留之前的訊息，如果消費者端沒收到就自動重送。</p>
<p>而為了確認消費者端有沒有收到訊息，所以 STAN 也多了 Ack 的概念，讓消費者端可以回報 STAN 說這個訊息處理成功了。如果 STAN 這端等太久沒收到 Ack，就會認為消費者沒有收到訊息而進行重送。</p>
<p>有時因為一些網路的原因，有可能會發生 STAN 認為消費者端沒收到，但其實有的情況，好比說消費者的 Ack 太慢送，導致 STAN 發生 Timeout 認為沒送到再送一次。一旦發生這種情況，相同的訊息就有可能會重送，所以實作上要設計成冪等的，系統要支持重複的訊息而不會發生錯誤才行。</p>
<img alt="11.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/11.png" style="width: 100%;">
<p>我們可以自行選擇使用自動 Ack 或是手動 Ack ，預設是自動 Ack，所以只要有正常收到，基本就當你成功了。</p>
<p>但我們通常不會把「收到訊息」就當作成功，而是把訊息當作一個「任務」，必須成功做完某件事才當作成功，不然就都算失敗，需要重做。</p>
<p>所以實務上通常會建議用手動，這樣才能確保自己能控制這個任務究竟是成功還是失敗。</p>
<div class="highlight"><pre><span></span><span class="nx">opts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">stan</span><span class="p">.</span><span class="nx">SubscriptionOption</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">stan</span><span class="p">.</span><span class="nx">SetManualAckMode</span><span class="p">(),</span><span class="w"> </span><span class="c1">// 手動 Ack 模式</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stanConn</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="s">"channel"</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">*</span><span class="nx">stan</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"收到了"</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">Data</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nx">msg</span><span class="p">.</span><span class="nx">Ack</span><span class="p">()</span><span class="w">  </span><span class="c1">// 手動 Ack</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="nx">opts</span><span class="o">...</span><span class="p">)</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"訂閱失敗"</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>某種程度而言，其實 STAN 就是在 Core NATS 之上再做了 Request / Reply 的功能。 Ack 就是類似 Reply 的效果。而原始的 Core NATS 如果沒收到 Reply，生產者端通常能做的就是重送，而 STAN 接手了這件事情，代替生產者端做同樣的事情。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">訂閱本身不影響 Channel 保留的內容， Ack 完的訊息也不會因此被刪掉</p>
</div>
</div>
<div class="section" id="stan-4">
<h3>STAN 的坑</h3>
<p>聽起來 STAN 似乎很美好，但實際使用時其實有很多坑，剛剛提到 STAN 其實是一個獨立的服務，它有自己的術語，有自己的函式庫，只是把 NATS 當作系統的底層。</p>
<p>我覺得概念本身沒問題，但問題是 STAN 並沒有完全把 NATS 隱藏起來，從之前的例子可知如果要調整一些設定，還是得引入 NATS 的函式庫，我認為這不是好的設計。</p>
<p>前面說過，NATS 有 Client ID (由服務端分配)，STAN 也有 Client ID (由客戶端自行指定)，STAN 沒能做到完全隱藏 NATS 的 Client ID，所以就會讓使用者感到困惑。</p>
<p>在連線的時候，如果要調整參數，還是得引入 NATS 的函式庫，沒辦法只用 STAN 的函式庫就好。</p>
<div class="highlight"><pre><span></span><span class="c1">// 連線</span><span class="w"></span>
<span class="nx">stanConn</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stan</span><span class="p">.</span><span class="nx">Connect</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">"test-cluster"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">"clientID"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">stan</span><span class="p">.</span><span class="nx">NatsURL</span><span class="p">(</span><span class="s">"nats://localhost:4222"</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nx">stan</span><span class="p">.</span><span class="nx">NatsOptions</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="nx">nats</span><span class="p">.</span><span class="nx">Name</span><span class="p">(</span><span class="s">"NATS 連線名稱"</span><span class="p">),</span><span class="w">   </span><span class="c1">// 這項設定需要引入 nats 函式庫</span><span class="w"></span>
<span class="w">    </span><span class="p">),</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"連不上 STAN"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">defer</span><span class="w"> </span><span class="nx">stanConn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span><span class="w"></span>
</pre></div>
<p>上述的問題可能影響不大，但由於 STAN 和 NATS 是各自獨立的服務器，而且連結並沒有想像中緊密，好比說 NATS 和 STAN 兩者各自都有自己的斷線判斷，而最糟糕的是－－兩者判斷可能不同。</p>
<p>有可能 NATS 認定斷線，但 STAN 沒有；又或是相反，STAN 認定斷線，但 NATS 沒有。這時就會碰到很大的麻煩，有可能會發生表面上 NATS 還在連線，但其實沒有辦法收到任何訊息的狀況。</p>
<p>簡單來說，就是它本身的斷線重連機制根本沒辦法正常運作，無法做到用戶無感知，必須自行處理，自行重新訂閱才行。這件事一直在我寫這篇文章時似乎都沒有好的解法，我目前的做法就是只要偵測到斷線，就直接整個重連(包含 NATS 和 STAN 的連線)。</p>
</div>
<div class="section" id="stan-5">
<h3>STAN 小結</h3>
<p>這邊做個簡單的小結，STAN 就是有持久化功能的 NATS，效能也相當不錯，延遲同樣比 Kafka 好，但因為最初設計的一些原因，所以也帶來了許多的坑。</p>
<p>使用上其實沒有太大的問題，除了……被開發團隊放生以外？</p>
</div>
</div>
<div class="section" id="jetstream">
<h2>JetStream</h2>
<p>最後則是本篇的重頭戲－－JetStream。</p>
<p>它是開發團隊用來取代 STAN 的新方案，所以也提供了 STAN 類似的功能，但功能更豐富也更強大，同時還修正了 STAN 碰到的問題。</p>
<p>這次的 JetStream 不再和 STAN 一樣是獨立的服務，而是 NATS 本身的子系統，第一個顯而易見的好處不用再分別啟動 NATS 和 STAN 不同的服務器，只要在 NATS 的服務器簡單加了一個參數就可以用 JetStream 了，可以顯著的減少維運的成本。</p>
<div class="highlight"><pre><span></span>sudo docker run nats:2.6.1 -js  <span class="c1"># 加上 -js 即可支援 JetStream</span>
</pre></div>
<p>在開發上，也不用再引入不同的函式庫，直接使用 NATS 本身的函式庫就好。如果要使用 JetStream，只要在 NATS 連線的基礎上直接取得 JetStream 的 Context 即可，非常簡單。</p>
<div class="section" id="jetstream-context">
<h3>範例 - 取得 JetStream 的 Context</h3>
<div class="highlight"><pre><span></span><span class="c1">// 連線</span><span class="w"></span>
<span class="nx">natsConn</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">nats</span><span class="p">.</span><span class="nx">Connect</span><span class="p">(</span><span class="s">"nats://localhost:4222"</span><span class="p">)</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"連不上 NATS"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">defer</span><span class="w"> </span><span class="nx">natsConn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span><span class="w"></span>

<span class="c1">// 取得 JetStream 的 Context</span><span class="w"></span>
<span class="nx">js</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">natsConn</span><span class="p">.</span><span class="nx">JetStream</span><span class="p">()</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">"取得 JetStream 的 Context 失敗: %v"</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>同時 JetStream 也帶來更多更強大的功能，比如可以更細緻的調整訊息的保留方式，除了可以像 STAN 一樣定義訊息的保留時間、大小、數量外，還可以進一步設定「如果沒 Ack 過就永久保留」或是「沒有任何訂閱就刪除」等更進階的功能。</p>
<p>而且訊息接收方式除了能由 JetStream 主動推訊息外，還多了可以讓消費者自行拉取訊息的模式。</p>
<p>使用上，JetStream 明確定義了兩個新概念：</p>
<ul class="simple">
<li>Stream - 負責管理存儲</li>
<li>Consumer - 負責管理消費</li>
</ul>
</div>
<div class="section" id="stream">
<h3>Stream</h3>
<p>Stream 定義了 NATS 訊息保留的規則，如果一條 NATS 訊息符合 Stream 設定的 Subject，就會被 JetStream 存下來。而 JetStream 就是透過管理 Stream 間接做持久化。</p>
<p>我們可以設定多個不同的 Stream，來對應多個 Subject，同時每個 Stream 也可以支援不同的存儲規則，像是可以自行選擇訊息保留的方式、丟棄的方式等。</p>
<img alt="12.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/12.png" style="width: 100%;">
<p>而這一切都不需要預先定義，可以在程式運作的過程中動態產生。</p>
</div>
<div class="section" id="stream-1">
<h3>範例 - 動態建立新的 Stream</h3>
<div class="highlight"><pre><span></span><span class="c1">// 建立 Stream</span><span class="w"></span>
<span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">js</span><span class="p">.</span><span class="nx">AddStream</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">nats</span><span class="p">.</span><span class="nx">StreamConfig</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">"Stream名稱"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">Subjects</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">"subject.*"</span><span class="p">,</span><span class="w"> </span><span class="c1">// 支援 wildcard</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">Storage</span><span class="p">:</span><span class="w">   </span><span class="nx">nats</span><span class="p">.</span><span class="nx">FileStorage</span><span class="p">,</span><span class="w">     </span><span class="c1">// 儲存的方式 (預設 FileStorage)</span><span class="w"></span>
<span class="w">    </span><span class="nx">Retention</span><span class="p">:</span><span class="w"> </span><span class="nx">nats</span><span class="p">.</span><span class="nx">WorkQueuePolicy</span><span class="p">,</span><span class="w"> </span><span class="c1">// 保留的策略</span><span class="w"></span>
<span class="w">    </span><span class="nx">Discard</span><span class="p">:</span><span class="w">   </span><span class="nx">nats</span><span class="p">.</span><span class="nx">DiscardOld</span><span class="p">,</span><span class="w">      </span><span class="c1">// 丟棄的策略</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">"建立 Stream 失敗: %v"</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>而代價則是開發者需要在程式裡顯式管理 Stream，無論是發送和接收，Subject 都必須確保有對應的 Stream 存在，不然就會報錯。</p>
<p>所以開發者一開始第一個可能碰到的坑，就是想如同用 NATS 一樣直接推送一則訊息，然後就會發現會因為沒有對應的 Stream 而推送失敗。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">補充： JetStream 和 NATS 相同，Subject 都能支援 wildcard，因為 JetStream 的訊息其實就是 NATS 的訊息，當然可以支援。</p>
</div>
</div>
<div class="section" id="consumer">
<h3>Consumer</h3>
<p>Consumer 則是定義了消費者接收的規則，消費者在訂閱某個 Subject 時，會自動產生對應的 Consumer。 Consumer 會包含相關的設定，同時還會維護一份紀錄，記錄消費者接收到的位置。</p>
<img alt="13.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/13.png" style="width: 100%;">
<p>JetStream 同樣也有  Durable 的概念，用法和 STAN 也基本相同，差別在於 JetStream 明確定義了 Consumer 的概念，所以對於 JetStream 來說，一個 Durable 就代表一個 Consumer。</p>
<p>具體來說就是如果消費者訂閱的時候指定了 Durable Name，那麼 JetStream 就會找尋同樣名稱的 Consumer，如果有，就直接從該 Consumer 記錄的位置開始發送訊息，而不是從頭開始。</p>
</div>
<div class="section" id="push-pull-subscription">
<h3>Push / Pull Subscription</h3>
<p>除此之外， JetStream 還多了 Push 和 Pull 的概念，過去 NATS 和 STAN 都是用 Push 的方式由 MQ 推送訊息給消費者，而 JetStream 則再多了 Pull 的方法，讓消費者可以主動和 MQ 要訊息，更好的區分不同的用途。</p>
<img alt="14.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/14.png" style="width: 100%;">
<p>簡單來說  Push 的方式就是 JetStream 會不管三七二十一狂推，適合量少需要極低延遲的任務，比如說即時監控，Pull 的話就是由消費者主動拉訊息，適合當 Worker 使用。</p>
<p>兩種方式比較，雖然 Push 會有更低的延遲，更快的速度，但如果對方收不到這麼快也沒用，還可能被當成 Slow consumer 而被踢掉，所以兩種方式各有用途。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">要減少 Slow consumer 的問題，可以設定 RateLimit 或是直接用 Max Pending 來解決。</p>
</div>
</div>
<div class="section" id="push-subscription">
<h3>範例 - Push Subscription</h3>
<div class="highlight"><pre><span></span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">js</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="s">"subject"</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">*</span><span class="nx">nats</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"收到了"</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">Data</span><span class="p">))</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"訂閱失敗"</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>用法和 NATS 的幾乎一模一樣，差別是改用 JetStream 的 Context 來操作 (此例為 js)。</p>
</div>
<div class="section" id="pull-subscription">
<h3>範例 - Pull Subscription</h3>
<div class="highlight"><pre><span></span><span class="nx">sub</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">js</span><span class="p">.</span><span class="nx">PullSubscribe</span><span class="p">(</span><span class="s">"subject"</span><span class="p">,</span><span class="w"> </span><span class="s">"durable"</span><span class="p">)</span><span class="w"> </span><span class="c1">// Pull 模式必須要用 Durable</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">"訂閱失敗: %w"</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">for</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">msgs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sub</span><span class="p">.</span><span class="nx">Fetch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="c1">// 決定一次收幾條</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">"接收失敗: %w"</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">msgs</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"收到了"</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">Data</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="nx">msg</span><span class="p">.</span><span class="nx">Ack</span><span class="p">()</span><span class="w"> </span><span class="c1">// 要手動 Ack</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>在 Pull 模式，使用差異比較大，消費者要自行主動拉資料，可以決定一次要拉幾條，訂閱的時候必須使用 durable，而且必須強制手動 Ack。</p>
</div>
<div class="section" id="ack">
<h3>Ack</h3>
<p>提到 Ack，JetStream 也帶來了相比 STAN 更豐富的 Ack 機制，除了能回傳代表成功的 Ack，也多了代表失敗的 Nak 或是還沒好的 Progress 等等。</p>
<p>原本在 STAN 中，如果訊息處理失敗的時候，就只能讓 STAN 等到 Timeout，才能判斷失敗。但現在 JetStream 可以讓消費者主動回傳 Nak，讓服務器能更快知道該訊息處理失敗了。</p>
</div>
<div class="section" id="ack-1">
<h3>豐富的 Ack 機制</h3>
<table border="1" class="docutils">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">功能</th>
<th class="head">簡易說明</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>AckAck</td>
<td>搞好了</td>
</tr>
<tr><td>AckNak</td>
<td>沒搞成</td>
</tr>
<tr><td>AckProgress</td>
<td>還在搞</td>
</tr>
<tr><td>AckNext</td>
<td>先搞下一個</td>
</tr>
<tr><td>AckTerm</td>
<td>這個我不搞</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="ack-2">
<h3>多樣的 Ack 策略</h3>
<table border="1" class="docutils">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">策略</th>
<th class="head">說明</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>AckExplicit [預設]</td>
<td>每個訊息都要 Ack (每個都要明確的說搞好了)</td>
</tr>
<tr><td>AckNone</td>
<td>不用 ack(不用說搞好了沒)</td>
</tr>
<tr><td>AckAll</td>
<td>只需要 ack 最後一筆 (搞了這個，就當已經搞好之前所有的訊息)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="section-6">
<h3>「保證一次」交付模型</h3>
<p>JetStream 和 STAN 提供的都是「至少一次」的交付模型，但在限定條件下，它可以做到「保證一次」，來確保消費者不會收到重覆的訊息。</p>
<p>具體而言，JetStream 提供了兩種機制來確保「發送端不會重送」並且「接收端不會重收」兩件事，依此做到「保證一次」的效果。</p>
<p>要保證「發送端不會重送」，JetStream 的做法是讓生產者可以為每一則訊息自行指定「訊息 ID」， JetStream 會負責確保同樣的「訊息 ID」只會送一次。</p>
<p>簡單來說，它會在送完一筆訊息後，在一定時間內無視之後傳來所有相同「訊息 ID」的訊息，來達成不會重送的要求。</p>
<div class="highlight"><pre><span></span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">js</span><span class="p">.</span><span class="nx">Publish</span><span class="p">(</span><span class="s">"subject"</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">"Hello world"</span><span class="p">),</span><span class="w"> </span><span class="nx">nats</span><span class="p">.</span><span class="nx">MsgId</span><span class="p">(</span><span class="s">"訊息ID"</span><span class="p">))</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">"送不出去"</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>之所以要確保「發送端不會重送」，是因為發送端有可能會因為網路原因，明明訊息有送成功了，但卻沒收到 MQ 回傳的「收到訊息」以為自己沒發送成功，而再送一次的狀況。</p>
<p>如果沒有讓發送端自行指定訊息 ID，對於 JetStream 來說，它其實無法判斷某一則訊息到底是不是重複的。因為即使是完全同樣的訊息內容，在不同的業務中仍然可能代表不同的訊息，因此是否重複只有開發者才能決定。而 JetStream 的做法就是讓生產者自行決定訊息的 ID，如果是一樣的，就代表同一個訊息，反之則不是。</p>
<p>第二件事就是要確保「接收端不會重收」，這裡似乎有許多不同的說法，但大概念都是類似，要由消費者端主動確認來解決。</p>
<p>舉例來說，可以讓消費者透過 AckSync 或是限制時間的 Ack 來向 MQ 確認是否已經有消費者已經收到訊息了。</p>
<div class="highlight"><pre><span></span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">js</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="s">"subject"</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">*</span><span class="nx">nats</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"收到了"</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">Data</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">AckSync</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"Ack 沒送成功或是這個訊息 Ack 過了"</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</pre></div>
<p><tt class="docutils literal">AckSync</tt> 就是用同步的方式 Ack，也就是讓消費者端在 Ack 的時候能同步確認 MQ 有收到自己的 Ack。</p>
<p>之所以要這麼做是因為 JetStream 有可能因為網路原因沒收到消費者傳來的 Ack 而以為自己沒成功發送訊息而重送。</p>
<p>而這件事同樣也只能由消費者端主動確認 MQ 是否有收到自己的 Ack，來確保 MQ 不會因為沒收到消費者端的 Ack 而重送(即使重送了也可以判斷出來)。</p>
<p>雖說 JetStream 號稱可以做到「只有一次」，不過我覺得這樣的代價似乎過大，每個 Ack 都要雙重確認絕對會顯著拖慢效能，感覺沒有必要強求只有一次。</p>
</div>
<div class="section" id="jetstream-1">
<h3>JetStream 的坑</h3>
<p>說了這麼多 JetStream 的好處，但 JetStream 其實也有很多問題，首先是它是全新的東西，因此可以想見穩定性自然是比較差的，甚至有些語言的實作到目前為止（2022/01/17）都還是 Beta 版。</p>
<img alt="15.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/15.png" style="width: 100%;">
<p>同時也因為是新東西，所以文件也非常少，有時必須要直接去 github 查程式碼才行。</p>
<img alt="16.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/16.png" style="width: 100%;">
<p>而且更討厭的是官網 NATS、NATS Streaming 和 JetStream 三套產品全部放在同一份文件裡，而三個工具各有不同的概念，名詞定義也有差異，卻可能共用同樣的名字，所以非常容易混淆。</p>
<img alt="17.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/17.png" style="width: 100%;">
<p>偏偏 JetStream 也不能只看 JetStream 的文件，因為是共用 NATS 的函式庫，所以許多概念還會延用，所以在查文件的時候就會覺得非常困擾。</p>
<p>另外雖說共用 NATS 函式庫很方便，但產生的缺點就是不同工具的方法也混雜在一起，好比說 NATS 和 JetStream 的訊息都是共用 <tt class="docutils literal">nats.Msg</tt> ，並沒有明確的分隔，所以可能會寫出令人困惑的程式碼。</p>
<div class="highlight"><pre><span></span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">natsConn</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">*</span><span class="nx">nats</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">msg</span><span class="p">.</span><span class="nx">Nak</span><span class="p">()</span><span class="w">  </span><span class="c1">// 這玩意兒是給 JetStream 用的，但也不會報錯</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</pre></div>
<p>最後一點則是 JetStream 本身的機制似乎也還沒成熟，光是我剛剛提的「保證一次」這件機制就有不同的說法，而且也都不是很明確，我覺得這也是個很嚴重的問題。</p>
</div>
<div class="section" id="jetstream-2">
<h3>JetStream 小結</h3>
<p>同樣做個小結， JetStream 相比 STAN 確實有許多優勢。</p>
<p>好比說架設方便，由於 JetStream 是 NATS Server 的子系統，加參數就可以使用，不用付出維護兩套服務器的成本。</p>
<p>而且 JetStream 不但功能比 STAN 更豐富更強大，而且效能還更好（這個後面會提）。</p>
<p>並且還因為是直接使用 NATS 本身的函式庫，使用上也比 STAN 簡單，幾乎在各方面都能輾壓 STAN。</p>
<p>但缺點是因為是新東西，穩定性可能比較差，同時有些語言的實作還是 beta 版，所以文件也很少，有時必須得直接看程式碼。</p>
</div>
</div>
<div class="section" id="section-7">
<h2>我流簡易評測</h2>
<p>這裡我簡單做一個效能評測，因為現在 JetStream 還是很新的東西，可能不穩定，比較沒有參考價值，所以我只挑選幾項我個人比較在意的項目做比較。</p>
<div class="section" id="section-8">
<h3>測試環境</h3>
<p>三台 Server</p>
<ul class="simple">
<li>8 Core CPU</li>
<li>32GB ram</li>
</ul>
</div>
<div class="section" id="section-9">
<h3>發布相關效能比較</h3>
<p>從下圖可以很明顯的看出 JetStream 的發布效能比較好。</p>
<img alt="STAN 和 JetStream 的發布 (Publish) 效能比較" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/18.png" style="width: 100%;">
<p>同時接收效能也是 JetStream 比較佳，同時也有更好的延遲表現。</p>
<img alt="STAN 和 JetStream 的接收 (Subscribe) 效能比較.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/19.png" style="width: 100%;">
<img alt="STAN 和 JetStream 的接收延遲效能比較.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/20.png" style="width: 100%;">
<p>最後再附上 JetStream 的各種接收方式的效能比較，可以看出 Subscribe 和 Chan Subscribe 差不多，而 Pull Subscribe 則較差，但是會隨著一次取得越多而越快。</p>
<img alt="JetStream 的各種接收 (Subscribe) 效能比較.png" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/21.png" style="width: 100%;">
</div>
</div>
<div class="section" id="section-10">
<h2>結語</h2>
<p>一個工具，有好有壞，適合自己公司的需求才是最重要的，雖然我個人研究了半天，但基於各種原因，我們最後還是沒用 JetStream。因此這邊單純只是做個簡單的紀錄，分享給有需要的人。</p>
<p>以上。</p>
</div>
<div class="section" id="section-11">
<h2>參考資料</h2>
<ul class="simple">
<li><a class="reference external" href="https://docs.nats.io/">NATS Docs</a></li>
<li><a class="reference external" href="https://github.com/nats-io/nats.go">nats-io/nats.go: Golang client for NATS, the cloud native messaging system.</a></li>
<li><a class="reference external" href="https://www.gushiciku.cn/pl/g4zz/zh-tw">NATS-Server(JetStream)和NATS Streaming Server對比</a></li>
<li><a class="reference external" href="https://www.jianshu.com/p/27a49b9d4306">基于NATS JetStream构建分布式事件流系统</a></li>
</ul>
</div>
</div></div>,<iframe title="iframe" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/button.html" style="border: 0px; margin: 48px 0px 0px; height: 212px; width: 100%; overflow: hidden;" id="iFrameResizer0" scrolling="no"></iframe>,<div class="mui-style-17s9njd e1fkhgjo0"><button title="淺談 NATS、STAN 和 JetStream 兩三事" aria-label="facebook" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#3b5998"></circle><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button></div>,<div><div id="disqus_thread"><iframe id="dsq-app3649" name="dsq-app3649" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 592px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div></div></article></section><aside class="mui-style-1vo0yqy eqexgzb0"><section class="e1vxuskl0 mui-style-1omjegw"><div class="mui-style-1pw1gpr e1vxuskl1"><h3>兩大類</h3><div class="mui-style-q4drfa e1vxuskl2"><div>能站著就別坐著，能走路就別騎車</div><div>保持站起來的毅力和一步一腳印的耐心</div></div><ul class="mui-style-n467ru e1vxuskl3"><li><a href="https://github.com/marco79423" target="_blank" class="mui-style-1d3byfs e1vxuskl7">GitHub</a></li><li><a href="https://twitter.com/marco79423" target="_blank" class="mui-style-15va7hz e1vxuskl5">Twitter</a></li></ul></div></section><section class="e12nzptw0 mui-style-uyir9q"><h2>相關網站</h2><ul><li><a class="mui-style-n1a5ie" href="https://paji-toolset.net/?utm_source=blog">啪唧工具包</a></li><li><a class="mui-style-n1a5ie" href="https://jessiclient.marco79423.net/?utm_source=blog">Jessiclient - Websocket 客戶端</a></li><li><a class="mui-style-n1a5ie" href="https://jessigod.marco79423.net/?utm_source=blog">西卡神教福音 - 西卡神福音傳播</a></li></ul></section><section class="e1xo01xw0 mui-style-uyir9q"><h2>近期文章</h2><ul><li><a class="mui-style-n1a5ie" href="https://marco79423.net/articles/%E9%9A%A8%E6%89%8B%E8%A8%98-k8s-%E7%9A%84%E6%86%91%E8%AD%89%E5%95%8F%E9%A1%8C%E8%A7%A3%E6%B1%BA">隨手記 - K8s 的憑證問題解決</a></li><li><a class="mui-style-n1a5ie" href="https://marco79423.net/articles/%E9%9A%A8%E6%89%8B%E8%A8%98-%E7%94%A8-ai-%E5%AF%AB-bitfinex-%E6%94%BE%E8%B2%B8%E6%A9%9F%E5%99%A8%E4%BA%BA">隨手記 - 用 AI 寫 Bitfinex 放貸機器人</a></li><li><a class="mui-style-n1a5ie" href="https://marco79423.net/articles/%E9%9A%A8%E6%89%8B%E8%A8%98-%E6%96%B0%E5%A2%9E-argo-cd-%E7%9A%84%E9%80%9A%E7%9F%A5">隨手記 - 新增 Argo CD 的通知</a></li><li><a class="mui-style-n1a5ie" href="https://marco79423.net/articles/%E9%9A%A8%E6%89%8B%E8%A8%98-%E9%87%8D%E6%96%B0%E9%96%8B%E5%A7%8B">隨手記 - 重新開始</a></li><li><a class="mui-style-n1a5ie" href="https://marco79423.net/articles/%E5%A6%82%E4%BD%95%E5%BE%9E-pchome-%E8%BD%89%E7%A7%BB%E5%9F%9F%E5%90%8D%E8%87%B3-godaddy">如何從 PCHome 轉移域名至 Godaddy？</a></li></ul></section><section class="e1d3gvig0 mui-style-uyir9q"><ul><li><a class="mui-style-n1a5ie" href="https://marco79423.net/articles/archives">所有文章列表</a></li></ul></section></aside></main><footer class="mui-style-8zrdw5 e6kni2g0"><div class="mui-style-19k5tfa e6kni2g1">Copyright © 2023 - 兩大類</div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"categories":[{"name":"技術分享","slug":"技術分享"}],"chickenCount":6,"content":"\u003cp\u003e事情是這個發生的……\u003c/p\u003e\n\u003cp\u003e因為公司新專案需要用到 MQ，所以我們選用了 NATS Streaming (STAN) 當作我們專案的 MQ。\u003c/p\u003e\n\u003cp\u003e沒想到如火如荼的密集開發一年後，某天在 Github 查看 STAN 的資料時才發現原來 STAN 要被開發團隊棄用了……\u003c/p\u003e\n\u003cimg alt=\"1.png\" src=\"https://marco79423.net/backend/static/c0ca08f2-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e（來源: \u003ca class=\"reference external\" href=\"https://github.com/nats-io/nats-streaming-server\"\u003ehttps://github.com/nats-io/nats-streaming-server\u003c/a\u003e）\u003c/p\u003e\n\u003cp\u003e……三小？\u003c/p\u003e\n\u003cp\u003e看上面說明，開發團隊建議改用他們的新產品 JetStream，取代現有的 STAN。\u003c/p\u003e\n\u003cp\u003e所以 JetStream 是啥？聽都沒聽過？\u003c/p\u003e\n\u003cp\u003e於是決定來研究一下 JetStream 究竟是何方神聖？並藉此機會順便回顧一下先前的 Core NATS 和 NATS Streaming 兩套產品，並且比較一下新舊產品的差異。\u003c/p\u003e\n\u003cp\u003e這次分享的主題主要有三個部分：\u003c/p\u003e\n\u003cul class=\"simple\"\u003e\n\u003cli\u003e一是簡單介紹 Message Queue (MQ) 的概念和其用途；\u003c/li\u003e\n\u003cli\u003e二是分別介紹 NATS、NATS Streaming 和這次的重點 JetStream；\u003c/li\u003e\n\u003cli\u003e最後再做個簡易的評測。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"section\" id=\"message-queue-mq\"\u003e\n\u003ch2\u003eMessage Queue (MQ)\u003c/h2\u003e\n\u003cp\u003eMessage Queue (MQ)，時常翻譯為「訊息佇列」或「消息隊列」，常見的開源選擇有 RabbitMQ、Kafka 和今天要談的 NATS。\u003c/p\u003e\n\u003cimg alt=\"2.png\" src=\"https://marco79423.net/backend/static/c0c90268-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003eMessage Queue 本身可以簡單想像成是一個服務級別的 Queue，同樣訊息先進先出，差別在因為這是獨立的服務，所以通常必須異步處理；另一個分別是通常 Queue 是一進一出，一則訊息被一個消費者接收，另一個就收不到，但 Message Queue 可以做到讓每個消費者都能收到全部的訊息(這通常是可選的)。\u003c/p\u003e\n\u003cp\u003eMQ 概念上大致可以分別兩個角色，分別是：\u003c/p\u003e\n\u003cul class=\"simple\"\u003e\n\u003cli\u003e生產者 (Producer)\u003c/li\u003e\n\u003cli\u003e消費者 (Consumer)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e生產者負責生產訊息 (Message)，並丟進 MQ，而消費者負責接收並處理訊息。兩者可以完全不用知道對方，只要和 MQ 溝通即可。\u003c/p\u003e\n\u003cp\u003e換句話說，只要生產者產生的訊息符合消費者能接收的格式，那麼其實不一定具體非得由哪個生產者才能生產。因為無論是單個生產者還是多個不同的生產者，對身為接收端的消費者都無所謂，只要能正常收到符合條件格式的訊息即可。\u003c/p\u003e\n\u003cp\u003e反過來也是如此，生產者只管生產，至於後端究竟有多少個消費者消費，對生產者來說無關緊要，也不會影響程式碼，可以讓生產者和消費者各自都擁有最大的彈性。\u003c/p\u003e\n\u003cp\u003e套用我流解釋，使用 MQ 可以有幾個好處：\u003c/p\u003e\n\u003cul class=\"simple\"\u003e\n\u003cli\u003e更簡單\u003c/li\u003e\n\u003cli\u003e更可靠\u003c/li\u003e\n\u003cli\u003e更大更強\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"section\" id=\"section-1\"\u003e\n\u003ch3\u003e更簡單 - 程式簡化和解耦\u003c/h3\u003e\n\u003cimg alt=\"3.png\" src=\"https://marco79423.net/backend/static/c0c98864-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e使用 MQ 可以方便讓不同服務解耦，正如前面所說，所有服務不管是生產者還是消費者 ，全部都統一都只和 MQ 溝通，生產者不用管是誰處理或是什麼時候處理，而消費者也不用管是誰生產的內容。\u003c/p\u003e\n\u003cp\u003e因此無論是生產者還是消費者都可以自由的拆分成多個服務，讓每個服務都只負責一件事，程式碼可以很單純。\u003c/p\u003e\n\u003cp\u003e也就是說只要能和 MQ 溝通，不管是用什麼程式語言、用什麼方式處理皆無所謂，就算後面其實是一隻雞在處理也可以。\u003c/p\u003e\n\u003cpre class=\"literal-block\"\u003e\n你永遠不會知道網路上和你聊天的是不是一隻雞，但如果他真的能用你理解的方式溝通、協作，那對方是不是只是一隻雞其實也沒差了。\n\u003c/pre\u003e\n\u003cp\u003e更進一步說，其實連時間也解耦了，因為中間隔了一層 MQ，所以不一定需要生產者和消費者同時在線上。\u003c/p\u003e\n\u003cp\u003e生產者在生產訊息時，沒人規定消費者非得即時在線上處理；反之亦然，消費者在處理訊息時，生產者也不一定要同時在線上生產訊息。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"section-2\"\u003e\n\u003ch3\u003e更可靠 - 服務掛掉也沒差的能力\u003c/h3\u003e\n\u003cimg alt=\"4.png\" src=\"https://marco79423.net/backend/static/c0ccec5c-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e在這個架構下，因為生產者或消費者不需要直接連結，所以即使服務掛掉，系統還能一定程度的繼續運作。\u003c/p\u003e\n\u003cp\u003e因為 MQ 通常都有一定程度的儲存訊息的能力，所以即使某一個消費者掛掉，也可以等到它復活後再繼續把之前沒推送成功的訊息再推送給它。\u003c/p\u003e\n\u003cp\u003e雖然處理時間多少會受影響，但至少訊息不會掉，在多數情境下，這樣也不會影響到系統的運作。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"section-3\"\u003e\n\u003ch3\u003e更大更強 - 大流量的緩衝\u003c/h3\u003e\n\u003cimg alt=\"5.png\" src=\"https://marco79423.net/backend/static/c0c80af2-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e網路服務的流量並不一定是恆定的，系統有時可能會突然面臨超大量的網路請求，但是即使要開更多台服務器也需要一點時間，這時 MQ 就可以當作「漏斗」一樣的功能，充當緩充。\u003c/p\u003e\n\u003cp\u003e等到足夠數量的服務啟動完畢，可以跟上訊息生產的速度了，就可以處理之前來不及處理的訊息了。\u003c/p\u003e\n\u003cdiv class=\"admonition note\"\u003e\n\u003cp class=\"first admonition-title\"\u003eNote\u003c/p\u003e\n\u003cp class=\"last\"\u003e另一種假設是這類超大量的網路請求不會一直持續，所以如果業務許可，也可以選擇不啟動新的服務器，讓 MQ 先接收下來就好，之後再讓消費者慢慢消化，用時間換取資源，也是一種選擇。\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"core-nats\"\u003e\n\u003ch2\u003eCore NATS\u003c/h2\u003e\n\u003cimg alt=\"6.png\" src=\"https://marco79423.net/backend/static/c0cdd7d4-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e這裡首先介紹 Core NATS，此處有個很容易混淆的點是 NATS 其實有三項產品：一是 Core NATS、另一是 NATS Streaming，最後還有最新的 JetStream。\u003c/p\u003e\n\u003cp\u003e因為官網的文件是直接把這三者的內容寫在一起，所以一開始沒看清楚很容易會以為是同樣的東西。但其實這是各自擁有不同概念的三項產品。\u003c/p\u003e\n\u003cp\u003eCore NATS（以下簡稱 NATS），一個開源、雲原生、用 Golang 寫的訊息傳遞系統，也是 NATS 最基礎的產品。\u003c/p\u003e\n\u003cp\u003eNATS 使用「發布」和「訂閱」的方式和程式溝通，並且不做任何持久性的處理，非常單純，所以效能也相當好。\u003c/p\u003e\n\u003cp\u003e程式操作也非常簡單，這裡介紹一下簡單的例子。\u003c/p\u003e\n\u003cdiv class=\"section\" id=\"nats\"\u003e\n\u003ch3\u003e範例 - NATS 連線\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 連線\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eConnect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;nats://localhost:4222\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;連不上 NATS\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003edefer\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"nats-1\"\u003e\n\u003ch3\u003e範例 - NATS 發送訊息\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 發送訊息\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePublish\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;subject\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"nb\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;Hello world\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;送不出去\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 清空緩衝\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFlush\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;清空失敗\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"admonition note\"\u003e\n\u003cp class=\"first admonition-title\"\u003eNote\u003c/p\u003e\n\u003cp\u003e基於效能因素，函式庫會先緩充要發送的訊息，直到一定量的時候才會發送。但如果應用程式有需求要確保想處理的已經確實處理好了，可以使用 flush 函式立即處理。\u003c/p\u003e\n\u003cp class=\"last\"\u003e(來源：\u003ca class=\"reference external\" href=\"https://docs.nats.io/developing-with-nats/sending/caches\"\u003ehttps://docs.nats.io/developing-with-nats/sending/caches\u003c/a\u003e)\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"nats-2\"\u003e\n\u003ch3\u003e範例 - NATS 接收訊息\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 接收訊息\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;subject\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMsg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;收到了\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e})\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;訂閱失敗\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"queue-groups\"\u003e\n\u003ch3\u003eQueue Groups\u003c/h3\u003e\n\u003cp\u003eNATS 內建 Load balancing 的功能，你可以在訂閱的時候隨便指定一個 Queue 的名稱，NATS 會確保訊息能自動分配訊息到同一個 Queue Group 的不同的消費者。\u003c/p\u003e\n\u003cimg alt=\"7.png\" src=\"https://marco79423.net/backend/static/c0cc8000-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 訂閱時直接指定 Queue 的名稱，不需要用設定檔預先設定\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eQueueSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;subject\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;queue\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMsg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;收到了\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e})\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;訂閱失敗\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e這樣一來，即使一個 Subject 有多個消費者一起處理，每則訊息也只會被處理一次，非常方便。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"section-4\"\u003e\n\u003ch3\u003e「最多一次」交付模型\u003c/h3\u003e\n\u003cp\u003e前面說到，NATS 本身不做任何持久性處理，換句話說，如果 NATS 發送訊息的時候如果沒人接，掉了就掉了， NATS 也不會理它，訊息便有可能會丟失。\u003c/p\u003e\n\u003cimg alt=\"8.png\" src=\"https://marco79423.net/backend/static/c0cb0c52-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e雖然 NATS 本身不管這件事，但它提供了一種稱為 Request / Reply 的解決方案。\u003c/p\u003e\n\u003cp\u003e簡單來說就兩件事：\u003c/p\u003e\n\u003cul class=\"simple\"\u003e\n\u003cli\u003e消費者主動回傳「收到」的訊息給生產者知道有收到\u003c/li\u003e\n\u003cli\u003e讓開發者自行解決有沒有收到的問題\u003c/li\u003e\n\u003c/ul\u003e\n\u003cimg alt=\"9.png\" src=\"https://marco79423.net/backend/static/c0cb92a8-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"request-reply\"\u003e\n\u003ch3\u003e範例 - Request / Reply 機制\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 自動建立一個唯一 subject\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ereply\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNewInbox\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 發送訊息\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePublishRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;subject\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003ereply\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"nb\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;Hello world\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;送不出去\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e此例的 reply 其實就是一個普通的 Subject，可以正常透過 Subscribe 監聽，用來接收消費者回傳的「收到」訊息。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 接收訊息\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;subject\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMsg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;收到了\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eRespond\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"nb\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;我收到了\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 生產者會監聽 reply，來確認消費者有沒有收到\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e})\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;訂閱失敗\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eRespond 意思就是回傳訊息給上例的 reply，只要生產者有監聽，就可以收到該訊息。藉此讓生產者自行處理「收到」或是「沒收到」的情況。\u003c/p\u003e\n\u003cp\u003e當然，這是有需要判斷有沒有收到的場景才需要這麼做，如果本身是不介意掉訊息的場景那就沒差了。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"nats-3\"\u003e\n\u003ch3\u003eNATS 小結\u003c/h3\u003e\n\u003cp\u003e簡單來說，Core NATS 的好處就是速度很快，簡單易用，而且對我來說因為是用 Golang 寫的，有什麼問題比較容易自己找到原因。\u003c/p\u003e\n\u003cp\u003e但因為有可能因為以消費者掛掉而掉訊息，所以適合需要大量、低延遲的場景 (比 Kafka 低很多)，而且不擔心漏訊息的場景 (或是能自行維護也行)。\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"nats-streaming-stan\"\u003e\n\u003ch2\u003eNATS Streaming (STAN)\u003c/h2\u003e\n\u003cp\u003eNATS Streaming，縮寫為 STAN，與前述的 Core NATS 相比，最重要的就是新增了持久化的功能，可以說就是「有持久化功能的 NATS」。\u003c/p\u003e\n\u003cp\u003e具體的應用場景，大約有下列四種情況：\u003c/p\u003e\n\u003cul class=\"simple\"\u003e\n\u003cli\u003e需要訊息的歷史紀錄 (需要 Replay data 的時候)\u003c/li\u003e\n\u003cli\u003eProducer 和 Consumer 高度解偶，有可能不是同時在線\u003c/li\u003e\n\u003cli\u003eProducer 和 Consumer 需要按照自己的節奏發送、或是接收資料\u003c/li\u003e\n\u003cli\u003e最後一條訊息對 Consumer 是必須的 (Producer 可能離線)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e根據官方的說法，其實大部分用原始的 NATS 即可，如果要確保收到，可以透過前述的 Request / Reply 機制解決，官方相信自行在應用端管理，長久下來會比直接用 STAN 更加穩定。\u003c/p\u003e\n\u003cp\u003e(當然啦，身為苦逼的開發者，不一定都有機會可以能長遠的看待問題就是了……)\u003c/p\u003e\n\u003cdiv class=\"section\" id=\"stan\"\u003e\n\u003ch3\u003e獨立的 STAN\u003c/h3\u003e\n\u003cp\u003e雖然乍聽起來， STAN 好像只是 NATS 多了持久化的功能而已，但其實兩者幾乎是完全不同的東西， STAN 有完全屬於自己的概念，有自己獨立的函式庫，只是函式庫內部使用 NATS 連線而已。\u003c/p\u003e\n\u003cimg alt=\"10.png\" src=\"https://marco79423.net/backend/static/c0c68d3a-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e由於 STAN 只是將 NATS 當作連線工具使用，會用自己的方式將資訊做包裝，如果你直接透過 NATS 來觀察，你發現完全看不出什麼鬼。\u003c/p\u003e\n\u003cp\u003e簡單來說， STAN 與 NATS 是不同的東西。\u003c/p\u003e\n\u003cp\u003e好比說客戶端在連上 STAN 需要指定使用的 Cluster ID，也要自行指定自己的 Client ID。\u003c/p\u003e\n\u003cp\u003e而這邊的 Client ID 是專屬於 NATS Streaming 的概念，並不是 NATS 的 Client ID (但因為是用 NATS 連線，所以同時仍然也會有 NATS 的 Client ID)。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"stan-1\"\u003e\n\u003ch3\u003e範例 - STAN 連線\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 連線\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003estanConn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003estan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eConnect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;test-cluster\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// Cluster ID\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;clientID\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 客戶端自設的 Client ID\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003estan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNatsURL\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;nats://localhost:4222\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003estan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNatsOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;NATS 連線名稱\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;連不上 STAN\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003edefer\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003estanConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e此外， STAN 使用的是 Channel 而非 Subject，雖然看似相同，但實際卻有差別。\u003c/p\u003e\n\u003cp\u003eNATS 原生的 Subject 可以支援 wildcard，我們可以在直接訂閱 \u003ccite\u003echicken.*\u003c/cite\u003e ，那麼無論是 \u003ccite\u003echicken.a\u003c/cite\u003e 又或是 \u003ccite\u003echicken.b\u003c/cite\u003e 也都能收到訊息，但 NATS Streaming 的 Channel 就不支援這麼做。\u003c/p\u003e\n\u003cdiv class=\"admonition note\"\u003e\n\u003cp class=\"first admonition-title\"\u003eNote\u003c/p\u003e\n\u003cp\u003e不知為何，雖然官網說 STAN 用的是 Channel 而非 Subject，但函式庫的命名還是使用 subject\u003c/p\u003e\n\u003cp class=\"last\"\u003e(來源： \u003ca class=\"reference external\" href=\"https://docs.nats.io/developing-with-nats-streaming/streaming\"\u003ehttps://docs.nats.io/developing-with-nats-streaming/streaming\u003c/a\u003e)\u003c/p\u003e\n\u003c/div\u003e\n\u003cp\u003e而 STAN 使用的訊息也是不同的物件，一個是 \u003ctt class=\"docutils literal\"\u003enats.Msg\u003c/tt\u003e 另一個是 \u003ctt class=\"docutils literal\"\u003estan.Msg\u003c/tt\u003e 。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"stan-2\"\u003e\n\u003ch3\u003e範例 - STAN 發送訊息\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 發送訊息\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003estanConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePublish\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;channel\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"nb\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;Hello world\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;送不出去\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"stan-3\"\u003e\n\u003ch3\u003e範例 - STAN 接收訊息\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 接收訊息\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003estanConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;channel\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003estan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMsg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 使用 stan.Msg\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;收到了\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e})\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;訂閱失敗\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"durable\"\u003e\n\u003ch3\u003eDurable\u003c/h3\u003e\n\u003cp\u003e因為 STAN 多了持久化的功能，所以消費者端這邊就不用在生產者生產訊息的時候即時接收，只要訊息還存在 STAN 裡，就可以自行選擇任意時間和位置開始接收訊息。\u003c/p\u003e\n\u003cp\u003e但是如果消費者端每次都要隨時自己記得自己收到哪裡也很麻煩，所以 STAN 也多了 Durable 的概念。\u003c/p\u003e\n\u003cp\u003eSTAN 本身會幫忙記錄消費者收到哪裡，如果消費者斷線回復，STAN 會自動從斷線的地方開始送。\u003c/p\u003e\n\u003cp\u003e消費者可以在訂閱的時候指定 Durable 名稱，STAN 會把消費者的 Client ID 和 Durable 當作 Key 記錄當前接收到的位置。假若消費者因故斷線重連，那麼 STAN 就會根據 Client ID 和 Durable 判斷從哪個位置開始發送。\u003c/p\u003e\n\u003cp\u003e由於 STAN 也支援前述的  Queue Groups 的功能，所以 STAN 的訂閱其實有四種組合，分別為：\u003c/p\u003e\n\u003ctable border=\"1\" class=\"docutils\"\u003e\n\u003ccolgroup\u003e\n\u003ccol width=\"50%\" /\u003e\n\u003ccol width=\"50%\" /\u003e\n\u003c/colgroup\u003e\n\u003cthead valign=\"bottom\"\u003e\n\u003ctr\u003e\u003cth class=\"head\"\u003e類型\u003c/th\u003e\n\u003cth class=\"head\"\u003e說明\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody valign=\"top\"\u003e\n\u003ctr\u003e\u003ctd\u003eRegular\u003c/td\u003e\n\u003ctd\u003e最基本的訂閱模式，當應用關掉、取消訂閱時，就會失去位置，下次訂閱需要重新指定\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eDurable\u003c/td\u003e\n\u003ctd\u003e消費者斷線時會保留位置，下次訂閱還會從上次最後接收的位置開始 (不包含主動取消訂閱)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eQueue\u003c/td\u003e\n\u003ctd\u003e多個消費者共享位置，但全部斷線就會失去位置\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eDurable / Queue\u003c/td\u003e\n\u003ctd\u003e多個消費者共享位置，但即使全部斷線也不會失去位置 (除非最後一個主動取消訂閱)\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e簡單來說， Durable 就是保留位置，而 Queue 就是共用位置，兩兩相乘就是四種可能。\u003c/p\u003e\n\u003cp\u003e至於 Durable 和 Durable / Queue 的差別在於前者以 ClientID 和 Durable 為 Key 記錄最後收到的訊息位置，而後者則是以 Queue 和 Durable 為 Key 來記錄。所以對於前者來說，如果不同 ClientID ，就會各自當不同的訂閱，而後者則會共用同一個。\u003c/p\u003e\n\u003ctable border=\"1\" class=\"docutils\"\u003e\n\u003ccolgroup\u003e\n\u003ccol width=\"50%\" /\u003e\n\u003ccol width=\"50%\" /\u003e\n\u003c/colgroup\u003e\n\u003ctbody valign=\"top\"\u003e\n\u003ctr\u003e\u003ctd\u003eDurable\u003c/td\u003e\n\u003ctd\u003eServer 會維護一份訂閱紀錄 (ClientID + Durable 為 Key) 記錄最後收到的訊息位置\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eDurable / Queue\u003c/td\u003e\n\u003ctd\u003eServer 同樣會維護一訂閱紀錄 (Queue + Durable 為 Key) 記錄最後收到的訊息位置 (這種情況下 ClientID 不重要)\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e(來源：\u003ca class=\"reference external\" href=\"https://github.com/nats-io/nats-streaming-server/issues/723#issuecomment-452361690\"\u003ehttps://github.com/nats-io/nats-streaming-server/issues/723#issuecomment-452361690\u003c/a\u003e)\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"section-5\"\u003e\n\u003ch3\u003e「至少一次」交付模型\u003c/h3\u003e\n\u003cp\u003e如果說 NATS 提供的是「最多一次」的交付模型，那麼 STAN 就是「至少一次」的交付模型，因為多了持久化的功能，所以 STAN 可以保留之前的訊息，如果消費者端沒收到就自動重送。\u003c/p\u003e\n\u003cp\u003e而為了確認消費者端有沒有收到訊息，所以 STAN 也多了 Ack 的概念，讓消費者端可以回報 STAN 說這個訊息處理成功了。如果 STAN 這端等太久沒收到 Ack，就會認為消費者沒有收到訊息而進行重送。\u003c/p\u003e\n\u003cp\u003e有時因為一些網路的原因，有可能會發生 STAN 認為消費者端沒收到，但其實有的情況，好比說消費者的 Ack 太慢送，導致 STAN 發生 Timeout 認為沒送到再送一次。一旦發生這種情況，相同的訊息就有可能會重送，所以實作上要設計成冪等的，系統要支持重複的訊息而不會發生錯誤才行。\u003c/p\u003e\n\u003cimg alt=\"11.png\" src=\"https://marco79423.net/backend/static/c0c4e8c2-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e我們可以自行選擇使用自動 Ack 或是手動 Ack ，預設是自動 Ack，所以只要有正常收到，基本就當你成功了。\u003c/p\u003e\n\u003cp\u003e但我們通常不會把「收到訊息」就當作成功，而是把訊息當作一個「任務」，必須成功做完某件事才當作成功，不然就都算失敗，需要重做。\u003c/p\u003e\n\u003cp\u003e所以實務上通常會建議用手動，這樣才能確保自己能控制這個任務究竟是成功還是失敗。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003eopts\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"nx\"\u003estan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSubscriptionOption\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003estan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSetManualAckMode\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 手動 Ack 模式\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003estanConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;channel\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003estan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMsg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;收到了\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eAck\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 手動 Ack\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eopts\u003c/span\u003e\u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;訂閱失敗\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e某種程度而言，其實 STAN 就是在 Core NATS 之上再做了 Request / Reply 的功能。 Ack 就是類似 Reply 的效果。而原始的 Core NATS 如果沒收到 Reply，生產者端通常能做的就是重送，而 STAN 接手了這件事情，代替生產者端做同樣的事情。\u003c/p\u003e\n\u003cdiv class=\"admonition note\"\u003e\n\u003cp class=\"first admonition-title\"\u003eNote\u003c/p\u003e\n\u003cp class=\"last\"\u003e訂閱本身不影響 Channel 保留的內容， Ack 完的訊息也不會因此被刪掉\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"stan-4\"\u003e\n\u003ch3\u003eSTAN 的坑\u003c/h3\u003e\n\u003cp\u003e聽起來 STAN 似乎很美好，但實際使用時其實有很多坑，剛剛提到 STAN 其實是一個獨立的服務，它有自己的術語，有自己的函式庫，只是把 NATS 當作系統的底層。\u003c/p\u003e\n\u003cp\u003e我覺得概念本身沒問題，但問題是 STAN 並沒有完全把 NATS 隱藏起來，從之前的例子可知如果要調整一些設定，還是得引入 NATS 的函式庫，我認為這不是好的設計。\u003c/p\u003e\n\u003cp\u003e前面說過，NATS 有 Client ID (由服務端分配)，STAN 也有 Client ID (由客戶端自行指定)，STAN 沒能做到完全隱藏 NATS 的 Client ID，所以就會讓使用者感到困惑。\u003c/p\u003e\n\u003cp\u003e在連線的時候，如果要調整參數，還是得引入 NATS 的函式庫，沒辦法只用 STAN 的函式庫就好。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 連線\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003estanConn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003estan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eConnect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;test-cluster\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;clientID\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003estan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNatsURL\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;nats://localhost:4222\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003estan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNatsOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;NATS 連線名稱\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 這項設定需要引入 nats 函式庫\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;連不上 STAN\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003edefer\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003estanConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e上述的問題可能影響不大，但由於 STAN 和 NATS 是各自獨立的服務器，而且連結並沒有想像中緊密，好比說 NATS 和 STAN 兩者各自都有自己的斷線判斷，而最糟糕的是－－兩者判斷可能不同。\u003c/p\u003e\n\u003cp\u003e有可能 NATS 認定斷線，但 STAN 沒有；又或是相反，STAN 認定斷線，但 NATS 沒有。這時就會碰到很大的麻煩，有可能會發生表面上 NATS 還在連線，但其實沒有辦法收到任何訊息的狀況。\u003c/p\u003e\n\u003cp\u003e簡單來說，就是它本身的斷線重連機制根本沒辦法正常運作，無法做到用戶無感知，必須自行處理，自行重新訂閱才行。這件事一直在我寫這篇文章時似乎都沒有好的解法，我目前的做法就是只要偵測到斷線，就直接整個重連(包含 NATS 和 STAN 的連線)。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"stan-5\"\u003e\n\u003ch3\u003eSTAN 小結\u003c/h3\u003e\n\u003cp\u003e這邊做個簡單的小結，STAN 就是有持久化功能的 NATS，效能也相當不錯，延遲同樣比 Kafka 好，但因為最初設計的一些原因，所以也帶來了許多的坑。\u003c/p\u003e\n\u003cp\u003e使用上其實沒有太大的問題，除了……被開發團隊放生以外？\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"jetstream\"\u003e\n\u003ch2\u003eJetStream\u003c/h2\u003e\n\u003cp\u003e最後則是本篇的重頭戲－－JetStream。\u003c/p\u003e\n\u003cp\u003e它是開發團隊用來取代 STAN 的新方案，所以也提供了 STAN 類似的功能，但功能更豐富也更強大，同時還修正了 STAN 碰到的問題。\u003c/p\u003e\n\u003cp\u003e這次的 JetStream 不再和 STAN 一樣是獨立的服務，而是 NATS 本身的子系統，第一個顯而易見的好處不用再分別啟動 NATS 和 STAN 不同的服務器，只要在 NATS 的服務器簡單加了一個參數就可以用 JetStream 了，可以顯著的減少維運的成本。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003esudo docker run nats:2.6.1 -js  \u003cspan class=\"c1\"\u003e# 加上 -js 即可支援 JetStream\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e在開發上，也不用再引入不同的函式庫，直接使用 NATS 本身的函式庫就好。如果要使用 JetStream，只要在 NATS 連線的基礎上直接取得 JetStream 的 Context 即可，非常簡單。\u003c/p\u003e\n\u003cdiv class=\"section\" id=\"jetstream-context\"\u003e\n\u003ch3\u003e範例 - 取得 JetStream 的 Context\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 連線\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eConnect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;nats://localhost:4222\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;連不上 NATS\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003edefer\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 取得 JetStream 的 Context\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ejs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eJetStream\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatalf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;取得 JetStream 的 Context 失敗: %v\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e同時 JetStream 也帶來更多更強大的功能，比如可以更細緻的調整訊息的保留方式，除了可以像 STAN 一樣定義訊息的保留時間、大小、數量外，還可以進一步設定「如果沒 Ack 過就永久保留」或是「沒有任何訂閱就刪除」等更進階的功能。\u003c/p\u003e\n\u003cp\u003e而且訊息接收方式除了能由 JetStream 主動推訊息外，還多了可以讓消費者自行拉取訊息的模式。\u003c/p\u003e\n\u003cp\u003e使用上，JetStream 明確定義了兩個新概念：\u003c/p\u003e\n\u003cul class=\"simple\"\u003e\n\u003cli\u003eStream - 負責管理存儲\u003c/li\u003e\n\u003cli\u003eConsumer - 負責管理消費\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"stream\"\u003e\n\u003ch3\u003eStream\u003c/h3\u003e\n\u003cp\u003eStream 定義了 NATS 訊息保留的規則，如果一條 NATS 訊息符合 Stream 設定的 Subject，就會被 JetStream 存下來。而 JetStream 就是透過管理 Stream 間接做持久化。\u003c/p\u003e\n\u003cp\u003e我們可以設定多個不同的 Stream，來對應多個 Subject，同時每個 Stream 也可以支援不同的存儲規則，像是可以自行選擇訊息保留的方式、丟棄的方式等。\u003c/p\u003e\n\u003cimg alt=\"12.png\" src=\"https://marco79423.net/backend/static/c0c43616-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e而這一切都不需要預先定義，可以在程式運作的過程中動態產生。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"stream-1\"\u003e\n\u003ch3\u003e範例 - 動態建立新的 Stream\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 建立 Stream\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003ejs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eAddStream\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eStreamConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;Stream名稱\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003eSubjects\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;subject.*\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 支援 wildcard\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003eStorage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFileStorage\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e     \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 儲存的方式 (預設 FileStorage)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003eRetention\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eWorkQueuePolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 保留的策略\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003eDiscard\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eDiscardOld\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 丟棄的策略\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ...\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e})\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatalf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;建立 Stream 失敗: %v\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e而代價則是開發者需要在程式裡顯式管理 Stream，無論是發送和接收，Subject 都必須確保有對應的 Stream 存在，不然就會報錯。\u003c/p\u003e\n\u003cp\u003e所以開發者一開始第一個可能碰到的坑，就是想如同用 NATS 一樣直接推送一則訊息，然後就會發現會因為沒有對應的 Stream 而推送失敗。\u003c/p\u003e\n\u003cdiv class=\"admonition note\"\u003e\n\u003cp class=\"first admonition-title\"\u003eNote\u003c/p\u003e\n\u003cp class=\"last\"\u003e補充： JetStream 和 NATS 相同，Subject 都能支援 wildcard，因為 JetStream 的訊息其實就是 NATS 的訊息，當然可以支援。\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"consumer\"\u003e\n\u003ch3\u003eConsumer\u003c/h3\u003e\n\u003cp\u003eConsumer 則是定義了消費者接收的規則，消費者在訂閱某個 Subject 時，會自動產生對應的 Consumer。 Consumer 會包含相關的設定，同時還會維護一份紀錄，記錄消費者接收到的位置。\u003c/p\u003e\n\u003cimg alt=\"13.png\" src=\"https://marco79423.net/backend/static/c0c79f40-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003eJetStream 同樣也有  Durable 的概念，用法和 STAN 也基本相同，差別在於 JetStream 明確定義了 Consumer 的概念，所以對於 JetStream 來說，一個 Durable 就代表一個 Consumer。\u003c/p\u003e\n\u003cp\u003e具體來說就是如果消費者訂閱的時候指定了 Durable Name，那麼 JetStream 就會找尋同樣名稱的 Consumer，如果有，就直接從該 Consumer 記錄的位置開始發送訊息，而不是從頭開始。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"push-pull-subscription\"\u003e\n\u003ch3\u003ePush / Pull Subscription\u003c/h3\u003e\n\u003cp\u003e除此之外， JetStream 還多了 Push 和 Pull 的概念，過去 NATS 和 STAN 都是用 Push 的方式由 MQ 推送訊息給消費者，而 JetStream 則再多了 Pull 的方法，讓消費者可以主動和 MQ 要訊息，更好的區分不同的用途。\u003c/p\u003e\n\u003cimg alt=\"14.png\" src=\"https://marco79423.net/backend/static/c0c8898c-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e簡單來說  Push 的方式就是 JetStream 會不管三七二十一狂推，適合量少需要極低延遲的任務，比如說即時監控，Pull 的話就是由消費者主動拉訊息，適合當 Worker 使用。\u003c/p\u003e\n\u003cp\u003e兩種方式比較，雖然 Push 會有更低的延遲，更快的速度，但如果對方收不到這麼快也沒用，還可能被當成 Slow consumer 而被踢掉，所以兩種方式各有用途。\u003c/p\u003e\n\u003cdiv class=\"admonition note\"\u003e\n\u003cp class=\"first admonition-title\"\u003eNote\u003c/p\u003e\n\u003cp class=\"last\"\u003e要減少 Slow consumer 的問題，可以設定 RateLimit 或是直接用 Max Pending 來解決。\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"push-subscription\"\u003e\n\u003ch3\u003e範例 - Push Subscription\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003ejs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;subject\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMsg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;收到了\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e})\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;訂閱失敗\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e用法和 NATS 的幾乎一模一樣，差別是改用 JetStream 的 Context 來操作 (此例為 js)。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"pull-subscription\"\u003e\n\u003ch3\u003e範例 - Pull Subscription\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003esub\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003ejs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePullSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;subject\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;durable\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// Pull 模式必須要用 Durable\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003exerrors\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eErrorf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;訂閱失敗: %w\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003emsgs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003esub\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFetch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 決定一次收幾條\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003exerrors\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eErrorf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;接收失敗: %w\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003erange\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003emsgs\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;收到了\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eAck\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 要手動 Ack\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e在 Pull 模式，使用差異比較大，消費者要自行主動拉資料，可以決定一次要拉幾條，訂閱的時候必須使用 durable，而且必須強制手動 Ack。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"ack\"\u003e\n\u003ch3\u003eAck\u003c/h3\u003e\n\u003cp\u003e提到 Ack，JetStream 也帶來了相比 STAN 更豐富的 Ack 機制，除了能回傳代表成功的 Ack，也多了代表失敗的 Nak 或是還沒好的 Progress 等等。\u003c/p\u003e\n\u003cp\u003e原本在 STAN 中，如果訊息處理失敗的時候，就只能讓 STAN 等到 Timeout，才能判斷失敗。但現在 JetStream 可以讓消費者主動回傳 Nak，讓服務器能更快知道該訊息處理失敗了。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"ack-1\"\u003e\n\u003ch3\u003e豐富的 Ack 機制\u003c/h3\u003e\n\u003ctable border=\"1\" class=\"docutils\"\u003e\n\u003ccolgroup\u003e\n\u003ccol width=\"50%\" /\u003e\n\u003ccol width=\"50%\" /\u003e\n\u003c/colgroup\u003e\n\u003cthead valign=\"bottom\"\u003e\n\u003ctr\u003e\u003cth class=\"head\"\u003e功能\u003c/th\u003e\n\u003cth class=\"head\"\u003e簡易說明\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody valign=\"top\"\u003e\n\u003ctr\u003e\u003ctd\u003eAckAck\u003c/td\u003e\n\u003ctd\u003e搞好了\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eAckNak\u003c/td\u003e\n\u003ctd\u003e沒搞成\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eAckProgress\u003c/td\u003e\n\u003ctd\u003e還在搞\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eAckNext\u003c/td\u003e\n\u003ctd\u003e先搞下一個\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eAckTerm\u003c/td\u003e\n\u003ctd\u003e這個我不搞\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"ack-2\"\u003e\n\u003ch3\u003e多樣的 Ack 策略\u003c/h3\u003e\n\u003ctable border=\"1\" class=\"docutils\"\u003e\n\u003ccolgroup\u003e\n\u003ccol width=\"50%\" /\u003e\n\u003ccol width=\"50%\" /\u003e\n\u003c/colgroup\u003e\n\u003cthead valign=\"bottom\"\u003e\n\u003ctr\u003e\u003cth class=\"head\"\u003e策略\u003c/th\u003e\n\u003cth class=\"head\"\u003e說明\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody valign=\"top\"\u003e\n\u003ctr\u003e\u003ctd\u003eAckExplicit [預設]\u003c/td\u003e\n\u003ctd\u003e每個訊息都要 Ack (每個都要明確的說搞好了)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eAckNone\u003c/td\u003e\n\u003ctd\u003e不用 ack(不用說搞好了沒)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eAckAll\u003c/td\u003e\n\u003ctd\u003e只需要 ack 最後一筆 (搞了這個，就當已經搞好之前所有的訊息)\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"section-6\"\u003e\n\u003ch3\u003e「保證一次」交付模型\u003c/h3\u003e\n\u003cp\u003eJetStream 和 STAN 提供的都是「至少一次」的交付模型，但在限定條件下，它可以做到「保證一次」，來確保消費者不會收到重覆的訊息。\u003c/p\u003e\n\u003cp\u003e具體而言，JetStream 提供了兩種機制來確保「發送端不會重送」並且「接收端不會重收」兩件事，依此做到「保證一次」的效果。\u003c/p\u003e\n\u003cp\u003e要保證「發送端不會重送」，JetStream 的做法是讓生產者可以為每一則訊息自行指定「訊息 ID」， JetStream 會負責確保同樣的「訊息 ID」只會送一次。\u003c/p\u003e\n\u003cp\u003e簡單來說，它會在送完一筆訊息後，在一定時間內無視之後傳來所有相同「訊息 ID」的訊息，來達成不會重送的要求。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003ejs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePublish\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;subject\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"nb\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;Hello world\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMsgId\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;訊息ID\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;送不出去\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e之所以要確保「發送端不會重送」，是因為發送端有可能會因為網路原因，明明訊息有送成功了，但卻沒收到 MQ 回傳的「收到訊息」以為自己沒發送成功，而再送一次的狀況。\u003c/p\u003e\n\u003cp\u003e如果沒有讓發送端自行指定訊息 ID，對於 JetStream 來說，它其實無法判斷某一則訊息到底是不是重複的。因為即使是完全同樣的訊息內容，在不同的業務中仍然可能代表不同的訊息，因此是否重複只有開發者才能決定。而 JetStream 的做法就是讓生產者自行決定訊息的 ID，如果是一樣的，就代表同一個訊息，反之則不是。\u003c/p\u003e\n\u003cp\u003e第二件事就是要確保「接收端不會重收」，這裡似乎有許多不同的說法，但大概念都是類似，要由消費者端主動確認來解決。\u003c/p\u003e\n\u003cp\u003e舉例來說，可以讓消費者透過 AckSync 或是限制時間的 Ack 來向 MQ 確認是否已經有消費者已經收到訊息了。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003ejs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;subject\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMsg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;收到了\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eAckSync\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;Ack 沒送成功或是這個訊息 Ack 過了\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e})\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ctt class=\"docutils literal\"\u003eAckSync\u003c/tt\u003e 就是用同步的方式 Ack，也就是讓消費者端在 Ack 的時候能同步確認 MQ 有收到自己的 Ack。\u003c/p\u003e\n\u003cp\u003e之所以要這麼做是因為 JetStream 有可能因為網路原因沒收到消費者傳來的 Ack 而以為自己沒成功發送訊息而重送。\u003c/p\u003e\n\u003cp\u003e而這件事同樣也只能由消費者端主動確認 MQ 是否有收到自己的 Ack，來確保 MQ 不會因為沒收到消費者端的 Ack 而重送(即使重送了也可以判斷出來)。\u003c/p\u003e\n\u003cp\u003e雖說 JetStream 號稱可以做到「只有一次」，不過我覺得這樣的代價似乎過大，每個 Ack 都要雙重確認絕對會顯著拖慢效能，感覺沒有必要強求只有一次。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"jetstream-1\"\u003e\n\u003ch3\u003eJetStream 的坑\u003c/h3\u003e\n\u003cp\u003e說了這麼多 JetStream 的好處，但 JetStream 其實也有很多問題，首先是它是全新的東西，因此可以想見穩定性自然是比較差的，甚至有些語言的實作到目前為止（2022/01/17）都還是 Beta 版。\u003c/p\u003e\n\u003cimg alt=\"15.png\" src=\"https://marco79423.net/backend/static/c0c3913e-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e同時也因為是新東西，所以文件也非常少，有時必須要直接去 github 查程式碼才行。\u003c/p\u003e\n\u003cimg alt=\"16.png\" src=\"https://marco79423.net/backend/static/c0c71aa2-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e而且更討厭的是官網 NATS、NATS Streaming 和 JetStream 三套產品全部放在同一份文件裡，而三個工具各有不同的概念，名詞定義也有差異，卻可能共用同樣的名字，所以非常容易混淆。\u003c/p\u003e\n\u003cimg alt=\"17.png\" src=\"https://marco79423.net/backend/static/c0c60388-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e偏偏 JetStream 也不能只看 JetStream 的文件，因為是共用 NATS 的函式庫，所以許多概念還會延用，所以在查文件的時候就會覺得非常困擾。\u003c/p\u003e\n\u003cp\u003e另外雖說共用 NATS 函式庫很方便，但產生的缺點就是不同工具的方法也混雜在一起，好比說 NATS 和 JetStream 的訊息都是共用 \u003ctt class=\"docutils literal\"\u003enats.Msg\u003c/tt\u003e ，並沒有明確的分隔，所以可能會寫出令人困惑的程式碼。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nx\"\u003enatsConn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003esubject\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMsg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nx\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNak\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 這玩意兒是給 JetStream 用的，但也不會報錯\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003cspan class=\"p\"\u003e})\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e最後一點則是 JetStream 本身的機制似乎也還沒成熟，光是我剛剛提的「保證一次」這件機制就有不同的說法，而且也都不是很明確，我覺得這也是個很嚴重的問題。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"jetstream-2\"\u003e\n\u003ch3\u003eJetStream 小結\u003c/h3\u003e\n\u003cp\u003e同樣做個小結， JetStream 相比 STAN 確實有許多優勢。\u003c/p\u003e\n\u003cp\u003e好比說架設方便，由於 JetStream 是 NATS Server 的子系統，加參數就可以使用，不用付出維護兩套服務器的成本。\u003c/p\u003e\n\u003cp\u003e而且 JetStream 不但功能比 STAN 更豐富更強大，而且效能還更好（這個後面會提）。\u003c/p\u003e\n\u003cp\u003e並且還因為是直接使用 NATS 本身的函式庫，使用上也比 STAN 簡單，幾乎在各方面都能輾壓 STAN。\u003c/p\u003e\n\u003cp\u003e但缺點是因為是新東西，穩定性可能比較差，同時有些語言的實作還是 beta 版，所以文件也很少，有時必須得直接看程式碼。\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"section-7\"\u003e\n\u003ch2\u003e我流簡易評測\u003c/h2\u003e\n\u003cp\u003e這裡我簡單做一個效能評測，因為現在 JetStream 還是很新的東西，可能不穩定，比較沒有參考價值，所以我只挑選幾項我個人比較在意的項目做比較。\u003c/p\u003e\n\u003cdiv class=\"section\" id=\"section-8\"\u003e\n\u003ch3\u003e測試環境\u003c/h3\u003e\n\u003cp\u003e三台 Server\u003c/p\u003e\n\u003cul class=\"simple\"\u003e\n\u003cli\u003e8 Core CPU\u003c/li\u003e\n\u003cli\u003e32GB ram\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"section-9\"\u003e\n\u003ch3\u003e發布相關效能比較\u003c/h3\u003e\n\u003cp\u003e從下圖可以很明顯的看出 JetStream 的發布效能比較好。\u003c/p\u003e\n\u003cimg alt=\"STAN 和 JetStream 的發布 (Publish) 效能比較\" src=\"https://marco79423.net/backend/static/c0c59380-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e同時接收效能也是 JetStream 比較佳，同時也有更好的延遲表現。\u003c/p\u003e\n\u003cimg alt=\"STAN 和 JetStream 的接收 (Subscribe) 效能比較.png\" src=\"https://marco79423.net/backend/static/c0cc0d64-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cimg alt=\"STAN 和 JetStream 的接收延遲效能比較.png\" src=\"https://marco79423.net/backend/static/c0ca8a34-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003cp\u003e最後再附上 JetStream 的各種接收方式的效能比較，可以看出 Subscribe 和 Chan Subscribe 差不多，而 Pull Subscribe 則較差，但是會隨著一次取得越多而越快。\u003c/p\u003e\n\u003cimg alt=\"JetStream 的各種接收 (Subscribe) 效能比較.png\" src=\"https://marco79423.net/backend/static/c0cd54e4-4c88-11ee-9f5e-0242ac110003/\" style=\"width: 100%;\" /\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"section-10\"\u003e\n\u003ch2\u003e結語\u003c/h2\u003e\n\u003cp\u003e一個工具，有好有壞，適合自己公司的需求才是最重要的，雖然我個人研究了半天，但基於各種原因，我們最後還是沒用 JetStream。因此這邊單純只是做個簡單的紀錄，分享給有需要的人。\u003c/p\u003e\n\u003cp\u003e以上。\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"section\" id=\"section-11\"\u003e\n\u003ch2\u003e參考資料\u003c/h2\u003e\n\u003cul class=\"simple\"\u003e\n\u003cli\u003e\u003ca class=\"reference external\" href=\"https://docs.nats.io/\"\u003eNATS Docs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca class=\"reference external\" href=\"https://github.com/nats-io/nats.go\"\u003enats-io/nats.go: Golang client for NATS, the cloud native messaging system.\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca class=\"reference external\" href=\"https://www.gushiciku.cn/pl/g4zz/zh-tw\"\u003eNATS-Server(JetStream)和NATS Streaming Server對比\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca class=\"reference external\" href=\"https://www.jianshu.com/p/27a49b9d4306\"\u003e基于NATS JetStream构建分布式事件流系统\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/div\u003e\n","cover":"https://marco79423.net/backend/static/c0cdd7d4-4c88-11ee-9f5e-0242ac110003/","date":"2022-01-20","modifiedDate":null,"rawSummary":"事情是這個發生的……\n因為公司新專案需要用到 MQ，所以我們選用了 NATS Streaming (STAN) 當作我們專案的 MQ。\n沒想到如火如荼的密集開發一年後，某天在 Github 查看 STAN 的資料時才發現原來 ...","slug":"淺談-natsstan-和-jetstream-兩三事","summary":"\u003cp\u003e事情是這個發生的……\u003c/p\u003e\n\u003cp\u003e因為公司新專案需要用到 MQ，所以我們選用了 NATS Streaming (STAN) 當作我們專案的 MQ。\u003c/p\u003e\n\u003cp\u003e沒想到如火如荼的密集開發一年後，某天在 Github 查看 STAN 的資料時才發現原來 ...\u003c/p\u003e","title":"淺談 NATS、STAN 和 JetStream 兩三事","path":"/articles/淺談-natsstan-和-jetstream-兩三事","url":"https://marco79423.net/articles/淺談-natsstan-和-jetstream-兩三事"},"recentArticles":[{"categories":[{"name":"隨手記","slug":"隨手記"}],"chickenCount":0,"content":null,"cover":null,"date":"2023-08-31","modifiedDate":null,"rawSummary":"最近想幫自己的網站降低一些成本，我的主要網站是使用 GKE、Cloud SQL、Load Balancing 這幾個工具。\n但這些組合有點太貴了，所以我打算減少使用 Load Balancing，不再使用 Google 的憑證 ...","slug":"隨手記-k8s-的憑證問題解決","summary":"\u003cp\u003e最近想幫自己的網站降低一些成本，我的主要網站是使用 GKE、Cloud SQL、Load Balancing 這幾個工具。\u003c/p\u003e\n\u003cp\u003e但這些組合有點太貴了，所以我打算減少使用 Load Balancing，不再使用 Google 的憑證 ...\u003c/p\u003e","title":"隨手記 - K8s 的憑證問題解決","path":"/articles/隨手記-k8s-的憑證問題解決","url":"https://marco79423.net/articles/隨手記-k8s-的憑證問題解決"},{"categories":[{"name":"隨手記","slug":"隨手記"}],"chickenCount":0,"content":null,"cover":"https://marco79423.net/backend/static/bd754928-4c88-11ee-9f5e-0242ac110003/","date":"2023-05-23","modifiedDate":null,"rawSummary":"最近在嘗試 Bitfinex 放貸，想寫一個簡單的美金放貸機器人。\n突然想說不如就用最近很夯的 AI 寫寫看？\n想到就做，首先自然是帶動這波 AI 浪潮的 ChatGPT。\n（要事先聲明的是我沒有付費，所以是 GPT-3 ...","slug":"隨手記-用-ai-寫-bitfinex-放貸機器人","summary":"\u003cp\u003e最近在嘗試 Bitfinex 放貸，想寫一個簡單的美金放貸機器人。\u003c/p\u003e\n\u003cp\u003e突然想說不如就用最近很夯的 AI 寫寫看？\u003c/p\u003e\n\u003cp\u003e想到就做，首先自然是帶動這波 AI 浪潮的 ChatGPT。\u003c/p\u003e\n\u003cp\u003e（要事先聲明的是我沒有付費，所以是 GPT-3 ...\u003c/p\u003e","title":"隨手記 - 用 AI 寫 Bitfinex 放貸機器人","path":"/articles/隨手記-用-ai-寫-bitfinex-放貸機器人","url":"https://marco79423.net/articles/隨手記-用-ai-寫-bitfinex-放貸機器人"},{"categories":[{"name":"隨手記","slug":"隨手記"}],"chickenCount":1,"content":null,"cover":null,"date":"2023-05-13","modifiedDate":null,"rawSummary":"自從我將主要的傳訊軟體從 LINE 改為 Telegram 後，我就一直想要整合所有通知到 Telegram，因為 Telegram 不像 LINE 有次數上限，我可以盡情使用，不怕超過上限，能更方便得到最即時的通知 ...","slug":"隨手記-新增-argo-cd-的通知","summary":"\u003cp\u003e自從我將主要的傳訊軟體從 LINE 改為 Telegram 後，我就一直想要整合所有通知到 Telegram，因為 Telegram 不像 LINE 有次數上限，我可以盡情使用，不怕超過上限，能更方便得到最即時的通知 ...\u003c/p\u003e","title":"隨手記 - 新增 Argo CD 的通知","path":"/articles/隨手記-新增-argo-cd-的通知","url":"https://marco79423.net/articles/隨手記-新增-argo-cd-的通知"},{"categories":[{"name":"隨手記","slug":"隨手記"}],"chickenCount":0,"content":null,"cover":null,"date":"2023-03-16","modifiedDate":null,"rawSummary":"沈澱許久，前後也搞了多個網站，像是 啪唧工具包、 西卡神教福音、Jessiclient 和等等。\n過去我不停地開發新專案，累積了不少學習心得。只是因為內容太雜，不成體系，覺得不夠格寫一篇技術文章，因此只好先放著。\n時間一長，我也漸漸忘記這些經驗 ...","slug":"隨手記-重新開始","summary":"\u003cp\u003e沈澱許久，前後也搞了多個網站，像是 \u003ca class=\"reference external\" href=\"http://paji-toolset.net/\"\u003e啪唧工具包\u003c/a\u003e、 \u003ca class=\"reference external\" href=\"https://jessigod.marco79423.net/\"\u003e西卡神教福音\u003c/a\u003e、\u003ca class=\"reference external\" href=\"https://jessiclient.marco79423.net/\"\u003eJessiclient\u003c/a\u003e 和等等。\u003c/p\u003e\n\u003cp\u003e過去我不停地開發新專案，累積了不少學習心得。只是因為內容太雜，不成體系，覺得不夠格寫一篇技術文章，因此只好先放著。\u003c/p\u003e\n\u003cp\u003e時間一長，我也漸漸忘記這些經驗 ...\u003c/p\u003e","title":"隨手記 - 重新開始","path":"/articles/隨手記-重新開始","url":"https://marco79423.net/articles/隨手記-重新開始"},{"categories":[{"name":"技術分享","slug":"技術分享"}],"chickenCount":0,"content":null,"cover":"https://marco79423.net/backend/static/bcf9611e-4c88-11ee-9f5e-0242ac110003/","date":"2022-06-14","modifiedDate":null,"rawSummary":"多年來，一直覺得 PCHome 的網域很貴，所以時常在考慮換別的域名註冊商。\n最近我有了一個小發現，所以終於決定下定決心換到 GoDaddy。而我也注意到網路上好像沒有什麼關於從 PCHome 轉網域到 GoDaddy 的教學文章，所以來分享一下，順便做個紀錄 ...","slug":"如何從-pchome-轉移域名至-godaddy","summary":"\u003cp\u003e多年來，一直覺得 PCHome 的網域很貴，所以時常在考慮換別的域名註冊商。\u003c/p\u003e\n\u003cp\u003e最近我有了一個小發現，所以終於決定下定決心換到 GoDaddy。而我也注意到網路上好像沒有什麼關於從 PCHome 轉網域到 GoDaddy 的教學文章，所以來分享一下，順便做個紀錄 ...\u003c/p\u003e","title":"如何從 PCHome 轉移域名至 Godaddy？","path":"/articles/如何從-pchome-轉移域名至-godaddy","url":"https://marco79423.net/articles/如何從-pchome-轉移域名至-godaddy"}]},"__N_SSG":true},"page":"/articles/[slug]","query":{"slug":"淺談-natsstan-和-jetstream-兩三事"},"buildId":"PnrxW91pRMVoHT06zbRRp","runtimeConfig":{"GtagTrackerID":"UA-38552387-1","BackendServerUrl":"http://backend:8000/backend"},"isFallback":false,"gsp":true,"scriptLoader":[]}</script><next-route-announcer><p aria-live="assertive" id="__next-route-announcer__" role="alert" style="border: 0px; clip: rect(0px, 0px, 0px, 0px); height: 1px; margin: -1px; overflow: hidden; padding: 0px; position: absolute; width: 1px; white-space: nowrap; overflow-wrap: normal;"></p></next-route-announcer><iframe style="display: none;" src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/saved_resource(1).html"></iframe><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/720-b26d70a16eb47be9.js.下載"></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/[category]-9bc9a12a8ffc5d66.js.下載"></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/index-4705ffea7e0fa940.js.下載"></script><script src="./淺談 NATS、STAN 和 JetStream 兩三事 - 大類的技術手記_files/archives-3b5d19f55af6cd87.js.下載"></script></body></html>